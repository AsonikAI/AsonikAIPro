<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ya_Buxgalter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .bg-welcome {
            background: linear-gradient(135deg, #4c51bf 0%, #7c3aed 100%);
        }
        .glow-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .glow-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app" class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full">

        <!-- Основная навигация -->
        <nav class="flex justify-between items-center mb-10">
            <h1 class="text-3xl font-bold text-indigo-700">Ya_Buxgalter</h1>
            <div class="space-x-4">
                <button id="homeBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-full hover:bg-gray-300 transition duration-300">
                    Главная
                </button>
                <button id="myLessonsBtn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-full hover:bg-indigo-700 transition duration-300 hidden">
                    Мои уроки
                </button>
                <button id="adminPanelBtn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-full hover:bg-indigo-700 transition duration-300 hidden">
                    Админ-панель
                </button>
                <button id="loginBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-full hover:bg-gray-300 transition duration-300">
                    Вход
                </button>
                <button id="logoutBtn" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-full hover:bg-red-600 transition duration-300 hidden">
                    Выйти
                </button>
            </div>
        </nav>

        <!-- Раздел для отображения сообщений -->
        <div id="messageBox" class="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg hidden"></div>

        <!-- Главный раздел - Добро пожаловать -->
        <div id="welcomeSection" class="text-center p-8 rounded-lg bg-welcome text-white shadow-lg">
            <h2 class="text-4xl md:text-5xl font-extrabold mb-4">Добро пожаловать в Ya_Buxgalter!</h2>
            <p class="text-lg md:text-xl font-light mb-8">Ваш надежный партнер в мире бухгалтерии. Обучайтесь, развивайтесь и достигайте новых высот с нашими курсами.</p>
        </div>

        <!-- Раздел "Вход" -->
        <div id="loginSection" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-8">Вход для студентов</h2>
            <div class="max-w-md mx-auto bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200">
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="loginEmail" class="block text-gray-700 font-semibold mb-2">E-mail</label>
                        <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Введите ваш e-mail">
                    </div>
                    <div class="mb-6">
                        <label for="loginPassword" class="block text-gray-700 font-semibold mb-2">Пароль</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Введите ваш пароль">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-full hover:bg-indigo-700 transition duration-300">
                        Войти
                    </button>
                </form>
            </div>
            <div class="mt-4 text-center">
                <button id="googleLoginBtn" class="w-full max-w-md mx-auto bg-red-500 text-white font-semibold py-2 rounded-full hover:bg-red-600 transition duration-300">
                    Войти через Google
                </button>
            </div>
        </div>

        <!-- Панель управления (для авторизованных пользователей) -->
        <div id="dashboardSection" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-8">Мои уроки</h2>
            <p class="text-gray-600 text-center mb-6">Здесь вы найдете все видеоуроки и материалы, доступные по вашему курсу.</p>
            <div id="lessonsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Уроки будут загружаться сюда из Firestore -->
            </div>
        </div>
        
        <!-- Админ панель (только для администратора) -->
        <div id="adminPanel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-8">Админ-панель</h2>
            <div id="adminPanelContent" class="max-w-4xl mx-auto p-6 rounded-lg shadow-md border border-gray-200">
                <!-- Содержимое админ-панели будет загружаться сюда -->
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, onSnapshot, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Установка уровня логирования для отладки
    // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    // setLogLevel('debug');

    // Определение глобальных переменных Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB1FLSf6PBzNzb7_CWYH6Y0_--jhqO9MLQ",
      authDomain: "asonik-ai.firebaseapp.com",
      projectId: "asonik-ai",
      storageBucket: "asonik-ai.firebasestorage.app",
      messagingSenderId: "875716508614",
      appId: "1:875716508614:web:ad264fdd60a20eb7dd90c7",
      measurementId: "G-HT5T20YPVE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const appId = firebaseConfig.projectId;

    // Ссылки на элементы DOM
    const welcomeSection = document.getElementById('welcomeSection');
    const loginSection = document.getElementById('loginSection');
    const dashboardSection = document.getElementById('dashboardSection');
    const adminPanel = document.getElementById('adminPanel');
    const messageBox = document.getElementById('messageBox');
    const loginForm = document.getElementById('loginForm');
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const homeBtn = document.getElementById('homeBtn');
    const myLessonsBtn = document.getElementById('myLessonsBtn');
    const adminPanelBtn = document.getElementById('adminPanelBtn');

    // Функция для показа сообщений
    const showMessage = (message, isError = false) => {
        messageBox.textContent = message;
        messageBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
        if (isError) {
            messageBox.classList.add('bg-red-500');
        } else {
            messageBox.classList.add('bg-green-500');
        }
        messageBox.classList.add('animate-fadeIn');
        setTimeout(() => {
            messageBox.classList.add('hidden');
        }, 5000);
    };

    // Функция для отображения страниц
    const showPage = (pageId) => {
        welcomeSection.classList.add('hidden');
        loginSection.classList.add('hidden');
        dashboardSection.classList.add('hidden');
        adminPanel.classList.add('hidden');
        document.getElementById(pageId).classList.remove('hidden');
    };

    // Слушатель состояния авторизации
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userIsAdmin = await checkAdminStatus(user.uid);
            updateUI(user, userIsAdmin);
        } else {
            updateUI(null, false);
        }
    });

    // Функция для проверки прав администратора
    const checkAdminStatus = async (uid) => {
        try {
            const adminDocRef = doc(db, `artifacts/${appId}/public/data/admin_users/${uid}`);
            const adminDoc = await getDoc(adminDocRef);
            return adminDoc.exists() && adminDoc.data().isAdmin === true;
        } catch (error) {
            console.error("Ошибка при проверке прав администратора:", error);
            return false;
        }
    };

    // Функция для обновления интерфейса
    const updateUI = (user, isAdmin) => {
        if (user) {
            loginBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            myLessonsBtn.classList.remove('hidden');
            
            if (isAdmin) {
                adminPanelBtn.classList.remove('hidden');
                showAdminPanel();
            } else {
                adminPanelBtn.classList.add('hidden');
                showPage('dashboardSection');
                loadStudentLessons();
            }
        } else {
            loginBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            myLessonsBtn.classList.add('hidden');
            adminPanelBtn.classList.add('hidden');
            showPage('welcomeSection');
        }
    };

    // Обработчик входа по email/password
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = loginForm.loginEmail.value;
        const password = loginForm.loginPassword.value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
            showMessage("Вход выполнен успешно!");
        } catch (error) {
            showMessage("Ошибка входа: проверьте почту и пароль.", true);
        }
    });

    // Обработчик входа через Google
    googleLoginBtn.addEventListener('click', async () => {
        try {
            await signInWithPopup(auth, provider);
            showMessage("Вход через Google выполнен успешно!");
        } catch (error) {
            showMessage("Ошибка входа через Google: " + error.message, true);
        }
    });

    // Обработчик выхода
    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            showMessage("Выход выполнен успешно!");
        } catch (error) {
            showMessage("Ошибка выхода: " + error.message, true);
        }
    });

    // Навигационные кнопки
    homeBtn.addEventListener('click', () => showPage('welcomeSection'));
    loginBtn.addEventListener('click', () => showPage('loginSection'));
    myLessonsBtn.addEventListener('click', () => {
        showPage('dashboardSection');
        loadStudentLessons();
    });
    adminPanelBtn.addEventListener('click', () => showAdminPanel());

    // --- Функционал админ-панели ---
    const showAdminPanel = async () => {
        showPage('adminPanel');
        const adminContent = document.getElementById('adminPanelContent');
        adminContent.innerHTML = `
            <div class="flex flex-col md:flex-row mb-6">
                <button id="showManageLessonsBtn" class="w-full md:w-1/3 py-2 px-4 rounded-lg bg-indigo-500 text-white hover:bg-indigo-600 transition duration-300">Уроки</button>
                <button id="showManageStudentsBtn" class="w-full md:w-1/3 py-2 px-4 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-300">Студенты</button>
                <button id="showSettingsBtn" class="w-full md:w-1/3 py-2 px-4 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-300">Настройки</button>
            </div>
            <div id="adminTabContent"></div>
        `;
        document.getElementById('showManageLessonsBtn').addEventListener('click', () => {
            showAdminTab('manageLessons');
            document.querySelectorAll('#adminPanelContent button').forEach(btn => btn.classList.replace('bg-indigo-500', 'bg-gray-200'));
            document.getElementById('showManageLessonsBtn').classList.replace('bg-gray-200', 'bg-indigo-500');
        });
        document.getElementById('showManageStudentsBtn').addEventListener('click', () => {
            showAdminTab('manageStudents');
            document.querySelectorAll('#adminPanelContent button').forEach(btn => btn.classList.replace('bg-indigo-500', 'bg-gray-200'));
            document.getElementById('showManageStudentsBtn').classList.replace('bg-gray-200', 'bg-indigo-500');
        });
        document.getElementById('showSettingsBtn').addEventListener('click', () => {
            showAdminTab('settings');
            document.querySelectorAll('#adminPanelContent button').forEach(btn => btn.classList.replace('bg-indigo-500', 'bg-gray-200'));
            document.getElementById('showSettingsBtn').classList.replace('bg-gray-200', 'bg-indigo-500');
        });

        // По умолчанию показываем уроки
        showAdminTab('manageLessons');
        document.getElementById('showManageLessonsBtn').classList.replace('bg-gray-200', 'bg-indigo-500');
    };

    const showAdminTab = (tab) => {
        const adminTabContent = document.getElementById('adminTabContent');
        adminTabContent.innerHTML = ''; // Очищаем содержимое
        if (tab === 'manageLessons') {
            adminTabContent.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-bold mb-4">Добавить новый урок</h3>
                    <form id="addLessonForm">
                        <div class="mb-4">
                            <label for="lessonTitle" class="block text-gray-700 font-semibold mb-2">Название урока</label>
                            <input type="text" id="lessonTitle" class="w-full px-4 py-2 border rounded-lg" placeholder="Название">
                        </div>
                        <div class="mb-4">
                            <label for="lessonDescription" class="block text-gray-700 font-semibold mb-2">Описание</label>
                            <textarea id="lessonDescription" rows="3" class="w-full px-4 py-2 border rounded-lg" placeholder="Описание урока"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="lessonVideoUrl" class="block text-gray-700 font-semibold mb-2">URL видео</label>
                            <input type="text" id="lessonVideoUrl" class="w-full px-4 py-2 border rounded-lg" placeholder="Ссылка на YouTube, Vimeo и т.д.">
                        </div>
                        <div class="mb-6">
                            <label for="lessonThumbnailUrl" class="block text-gray-700 font-semibold mb-2">URL превью-картинки</label>
                            <input type="text" id="lessonThumbnailUrl" class="w-full px-4 py-2 border rounded-lg" placeholder="Ссылка на imgbb, Imgur и т.д.">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-full">Добавить урок</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Список всех уроков</h3>
                    <ul id="lessonsList" class="space-y-4"></ul>
                </div>
            `;
            loadLessons();
            document.getElementById('addLessonForm').addEventListener('submit', handleAddLesson);
        } else if (tab === 'manageStudents') {
            adminTabContent.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-bold mb-4">Добавить нового студента</h3>
                    <form id="addStudentForm">
                        <div class="mb-4">
                            <label for="studentName" class="block text-gray-700 font-semibold mb-2">Имя</label>
                            <input type="text" id="studentName" class="w-full px-4 py-2 border rounded-lg" placeholder="Имя">
                        </div>
                        <div class="mb-4">
                            <label for="studentSurname" class="block text-gray-700 font-semibold mb-2">Фамилия</label>
                            <input type="text" id="studentSurname" class="w-full px-4 py-2 border rounded-lg" placeholder="Фамилия">
                        </div>
                        <div class="mb-4">
                            <label for="studentEmail" class="block text-gray-700 font-semibold mb-2">E-mail</label>
                            <input type="email" id="studentEmail" class="w-full px-4 py-2 border rounded-lg" placeholder="Email">
                        </div>
                        <div class="mb-4">
                            <label for="studentPassword" class="block text-gray-700 font-semibold mb-2">Пароль</label>
                            <input type="password" id="studentPassword" class="w-full px-4 py-2 border rounded-lg" placeholder="Пароль">
                        </div>
                        <div class="mb-6">
                            <label for="studentBirthYear" class="block text-gray-700 font-semibold mb-2">Год рождения</label>
                            <input type="number" id="studentBirthYear" class="w-full px-4 py-2 border rounded-lg" placeholder="Год рождения">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-full">Добавить студента</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Список студентов</h3>
                    <ul id="studentsList" class="space-y-4"></ul>
                </div>
            `;
            loadStudents();
            document.getElementById('addStudentForm').addEventListener('submit', handleAddStudent);
        } else if (tab === 'settings') {
            adminTabContent.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">Добавить нового администратора</h3>
                    <form id="addAdminForm">
                        <div class="mb-4">
                            <label for="adminUid" class="block text-gray-700 font-semibold mb-2">UID пользователя</label>
                            <input type="text" id="adminUid" class="w-full px-4 py-2 border rounded-lg" placeholder="Введите UID">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-full">Сделать администратором</button>
                    </form>
                </div>
            `;
            document.getElementById('addAdminForm').addEventListener('submit', handleAddAdmin);
        }
    };

    // --- Функции загрузки данных из Firestore ---
    const loadLessons = () => {
        const lessonsRef = collection(db, `artifacts/${appId}/public/data/lessons`);
        onSnapshot(lessonsRef, (snapshot) => {
            const lessonsList = document.getElementById('lessonsList');
            lessonsList.innerHTML = '';
            snapshot.forEach(doc => {
                const lesson = doc.data();
                const li = document.createElement('li');
                li.className = 'p-4 bg-gray-100 rounded-lg shadow-sm';
                li.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <img src="${lesson.thumbnailUrl || 'https://placehold.co/120x80'}" alt="Превью урока" class="w-24 h-auto rounded-lg">
                        <div>
                            <h4 class="font-bold">${lesson.title}</h4>
                            <p class="text-gray-600 text-sm">${lesson.description}</p>
                        </div>
                    </div>
                `;
                lessonsList.appendChild(li);
            });
        });
    };

    const loadStudents = () => {
        const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
        onSnapshot(studentsRef, (snapshot) => {
            const studentsList = document.getElementById('studentsList');
            studentsList.innerHTML = '';
            snapshot.forEach(doc => {
                const student = doc.data();
                const li = document.createElement('li');
                li.className = 'p-4 bg-gray-100 rounded-lg shadow-sm';
                li.innerHTML = `
                    <h4 class="font-bold">${student.name} ${student.surname}</h4>
                    <p class="text-gray-600 text-sm">${student.email} (${student.birthYear})</p>
                `;
                studentsList.appendChild(li);
            });
        });
    };
    
    const loadStudentLessons = () => {
        const lessonsRef = collection(db, `artifacts/${appId}/public/data/lessons`);
        onSnapshot(lessonsRef, (snapshot) => {
            const lessonsContainer = document.getElementById('lessonsContainer');
            lessonsContainer.innerHTML = '';
            snapshot.forEach(doc => {
                const lesson = doc.data();
                const lessonCard = document.createElement('div');
                lessonCard.className = 'bg-gray-100 p-6 rounded-lg shadow-md';
                lessonCard.innerHTML = `
                    <h4 class="font-bold text-lg mb-2">${lesson.title}</h4>
                    <p class="text-gray-600 text-sm mb-4">${lesson.description}</p>
                    <div class="w-full aspect-video mb-4">
                        <iframe class="w-full h-full rounded-lg" src="${lesson.videoUrl}" frameborder="0" allowfullscreen></iframe>
                    </div>
                    <button class="w-full bg-indigo-500 text-white font-semibold py-2 rounded-full hover:bg-indigo-600 transition duration-300">Пройти тест</button>
                `;
                lessonsContainer.appendChild(lessonCard);
            });
        });
    };

    // --- Обработчики форм ---
    const handleAddLesson = async (e) => {
        e.preventDefault();
        const title = document.getElementById('lessonTitle').value;
        const description = document.getElementById('lessonDescription').value;
        const videoUrl = document.getElementById('lessonVideoUrl').value;
        const thumbnailUrl = document.getElementById('lessonThumbnailUrl').value;

        if (!title || !videoUrl) {
            showMessage("Пожалуйста, заполните все поля.", true);
            return;
        }

        try {
            await addDoc(collection(db, `artifacts/${appId}/public/data/lessons`), {
                title,
                description,
                videoUrl,
                thumbnailUrl
            });
            showMessage("Урок успешно добавлен!");
            document.getElementById('addLessonForm').reset();
        } catch (error) {
            showMessage("Ошибка при добавлении урока: " + error.message, true);
        }
    };
    
    const handleAddStudent = async (e) => {
        e.preventDefault();
        const name = document.getElementById('studentName').value;
        const surname = document.getElementById('studentSurname').value;
        const email = document.getElementById('studentEmail').value;
        const password = document.getElementById('studentPassword').value;
        const birthYear = document.getElementById('studentBirthYear').value;

        if (!name || !surname || !email || !password) {
            showMessage("Пожалуйста, заполните все обязательные поля.", true);
            return;
        }

        try {
            // Здесь должна быть логика для создания пользователя в Firebase Auth
            // Но мы будем просто добавлять в Firestore для демонстрации
            await addDoc(collection(db, `artifacts/${appId}/public/data/students`), {
                name,
                surname,
                email,
                birthYear,
                password // В реальном приложении пароль так хранить нельзя!
            });
            showMessage("Студент успешно добавлен!");
            document.getElementById('addStudentForm').reset();
        } catch (error) {
            showMessage("Ошибка при добавлении студента: " + error.message, true);
        }
    };

    const handleAddAdmin = async (e) => {
        e.preventDefault();
        const uid = document.getElementById('adminUid').value;
        if (!uid) {
            showMessage("Пожалуйста, введите UID.", true);
            return;
        }
        try {
            await setDoc(doc(db, `artifacts/${appId}/public/data/admin_users`, uid), { isAdmin: true });
            showMessage("Пользователь успешно добавлен в администраторы!");
            document.getElementById('addAdminForm').reset();
        } catch (error) {
            showMessage("Ошибка: " + error.message, true);
        }
    };
    </script>
</body>
</html>

