<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ya_Buxgalter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            background-color: var(--bg-color);
        }
        :root {
            --primary-color: #b91c1c; /* red-700 */
            --secondary-color: #ef4444; /* red-500 */
            --bg-color: #f3f4f6; /* gray-100 */
            --text-color: #1f2937; /* gray-800 */
            --card-bg-color: #ffffff; /* white */
        }
        body.dark-theme {
            --primary-color: #b91c1c; /* dark-red-700 */
            --secondary-color: #ef4444; /* red-500 */
            --bg-color: #1f2937; /* gray-800 */
            --text-color: #f9fafb; /* gray-50 */
            --card-bg-color: #374151; /* gray-700 */
        }
        .bg-welcome {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        .glow-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .glow-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .profile-menu {
            position: absolute;
            right: 0;
            top: 100%;
            z-index: 50;
        }
        .progress-circle {
            position: relative;
            width: 48px;
            height: 48px;
        }
        .progress-circle circle {
            width: 100%;
            height: 100%;
            fill: none;
            stroke-width: 4;
            transform: translate(2px, 2px);
        }
        .progress-circle .bg {
            stroke: #e5e7eb;
        }
        .progress-circle .progress {
            stroke: var(--progress-color);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s linear;
        }
    </style>
</head>
<body class="bg-bg-color">

    <div id="app" class="p-4 md:p-8 max-w-full w-full min-h-screen">

        <nav class="flex justify-between items-center mb-10">
            <h1 id="logoContainer" class="text-3xl font-bold text-primary-color flex items-center space-x-2">
                <img id="logoImg" src="https://placehold.co/40x40/b91c1c/ffffff?text=Y" alt="Логотип" class="w-10 h-10 rounded-md">
                <span id="logoText">Ya_Buxgalter</span>
            </h1>
            <div class="space-x-4 flex items-center relative">
                <button id="themeToggleBtn" class="p-2 rounded-full text-text-color hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg id="themeIconSun" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <svg id="themeIconMoon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
                <button id="showHomeBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-full hover:bg-gray-300 transition duration-300">
                    Главная
                </button>
                <button id="showCoursesBtn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-full hover:bg-indigo-700 transition duration-300">
                    Записаться на курс
                </button>
                <button id="showLoginBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-full hover:bg-gray-300 transition duration-300">
                    Вход для учеников
                </button>
                <button id="showDashboardBtn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-full hover:bg-indigo-700 transition duration-300 hidden">
                    Мои уроки
                </button>
                <div class="relative inline-block text-left hidden" id="userProfileDropdown">
                    <button id="profileMenuButton" class="flex items-center space-x-2 bg-indigo-600 text-white font-semibold py-2 px-6 rounded-full hover:bg-indigo-700 transition duration-300">
                        <img id="userAvatar" src="https://placehold.co/32x32" alt="Аватар" class="rounded-full w-8 h-8">
                        <span>Профиль</span>
                        <svg class="-mr-1 h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div id="profileMenu" class="profile-menu hidden origin-top-right mt-2 w-56 rounded-md shadow-lg bg-card-bg-color ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                        <div class="py-1" role="none">
                            <a href="#" id="dropdownShowProfileBtn" class="text-text-color block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" role="menuitem" tabindex="-1">Мой профиль</a>
                            <a href="#" id="logoutBtn" class="font-bold text-red-600 block px-4 py-2 text-sm hover:bg-red-50 dark:hover:bg-red-900/20" role="menuitem" tabindex="-1">Выйти</a>
                        </div>
                    </div>
                </div>
                <button id="showAdminPanelBtn" class="bg-orange-500 text-white font-semibold py-2 px-6 rounded-full hover:bg-orange-600 transition duration-300 hidden">
                    Админ-панель
                </button>
            </div>
        </nav>

        <div id="messageBox" class="hidden fixed top-5 right-5 text-white px-4 py-2 rounded-lg shadow-lg z-[100]"></div>

        <div id="welcomeSection">
            <div class="text-center p-8 rounded-lg bg-welcome text-white shadow-lg">
                <div class="flex flex-col md:flex-row items-center justify-center">
                    <div class="md:w-1/2 text-left">
                        <h2 class="text-4xl md:text-5xl font-extrabold mb-4 animate-fade-in">Добро пожаловать в Ya_Buxgalter!</h2>
                        <p class="text-lg md:text-xl font-light mb-8 animate-fade-in-delay">Ваш надежный партнер в мире бухгалтерии. Обучайтесь, развивайтесь и достигайте новых высот с нашими курсами.</p>
                        <div class="space-x-0 md:space-x-4 space-y-4 md:space-y-0">
                            <button id="welcomeCoursesBtn" class="bg-white text-indigo-700 font-semibold py-3 px-8 rounded-full shadow-lg glow-button text-lg">
                                Записаться на курс
                            </button>
                            <button id="welcomeContactBtn" class="bg-transparent border-2 border-white text-white font-semibold py-3 px-8 rounded-full shadow-lg glow-button text-lg">
                                Связаться с нами
                            </button>
                        </div>
                    </div>
                    <div class="md:w-1/2 mt-8 md:mt-0 md:ml-8 flex justify-center">
                        <img id="welcomeImage" src="https://placehold.co/400x300/4c51bf/ffffff?text=Ya_Buxgalter" alt="Modern office" class="rounded-lg shadow-xl">
                    </div>
                </div>
                
                <div class="mt-16 text-left max-w-4xl mx-auto">
                    <h3 class="text-3xl font-bold mb-4">Наши преимущества</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-xl font-semibold mb-2">Актуальные знания</h4>
                            <p class="text-gray-200">Мы постоянно обновляем наши курсы, чтобы они соответствовали последним изменениям в законодательстве.</p>
                        </div>
                        <div>
                            <h4 class="text-xl font-semibold mb-2">Практический опыт</h4>
                            <p class="text-gray-200">Обучение основано на реальных кейсах, что позволяет вам сразу применять полученные знания на практике.</p>
                        </div>
                        <div>
                            <h4 class="text-xl font-semibold mb-2">Поддержка экспертов</h4>
                            <p class="text-gray-200">Наши преподаватели — опытные бухгалтеры, готовые ответить на все ваши вопросы.</p>
                        </div>
                        <div>
                            <h4 class="text-xl font-semibold mb-2">Гибкий график</h4>
                            <p class="text-gray-200">Все материалы доступны 24/7. Вы можете учиться в удобное для вас время и в любом месте.</p>
                        </div>
                    </div>
                </div>

                <div class="mt-16 text-left max-w-5xl mx-auto">
                    <h3 class="text-3xl font-bold mb-8 text-center">Наши курсы</h3>
                    <div id="mainPageCoursesContainer" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        </div>
                </div>
            </div>
        </div>

        <div id="coursesSection" class="hidden">
            <h2 class="text-3xl font-bold text-center mb-8">Оставить заявку на курс</h2>
            <div class="max-w-md mx-auto bg-card-bg-color p-6 rounded-lg shadow-md border dark:border-gray-700">
                <form id="leadForm" class="space-y-4">
                     <div>
                        <label for="leadCourseType" class="block font-semibold mb-2">Тип курса</label>
                        <select id="leadCourseType" class="w-full px-4 py-2 border rounded-lg bg-card-bg-color dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            <option value="" disabled selected>Выберите тип курса</option>
                        </select>
                    </div>
                    <div>
                        <label for="leadName" class="block font-semibold mb-2">Имя</label>
                        <input type="text" id="leadName" class="w-full px-4 py-2 border rounded-lg bg-card-bg-color dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ваше имя" required>
                    </div>
                    <div>
                        <label for="leadLastName" class="block font-semibold mb-2">Фамилия</label>
                        <input type="text" id="leadLastName" class="w-full px-4 py-2 border rounded-lg bg-card-bg-color dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ваша фамилия" required>
                    </div>
                    <div>
                        <label for="leadPhone" class="block font-semibold mb-2">Телефон</label>
                        <input type="tel" id="leadPhone" class="w-full px-4 py-2 border rounded-lg bg-card-bg-color dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="+998 (XX) XXX-XX-XX" required>
                    </div>
                    <div>
                        <label for="leadTelegram" class="block font-semibold mb-2">Telegram (юзернейм)</label>
                        <input type="text" id="leadTelegram" class="w-full px-4 py-2 border rounded-lg bg-card-bg-color dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="@username" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-full hover:bg-indigo-700 transition duration-300">
                        Оставить заявку
                    </button>
                </form>
            </div>
        </div>

        <div id="loginSection" class="hidden">
            <h2 class="text-3xl font-bold text-center mb-8">Вход</h2>
            <div class="max-w-md mx-auto bg-card-bg-color p-6 rounded-lg shadow-md border dark:border-gray-700">
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block font-semibold mb-2">Логин</label>
                        <input type="text" id="loginEmail" class="w-full px-4 py-2 border rounded-lg bg-card-bg-color dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Введите ваш логин">
                    </div>
                    <div>
                        <label for="loginPassword" class="block font-semibold mb-2">Пароль</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-2 border rounded-lg bg-card-bg-color dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Введите ваш пароль">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-full hover:bg-indigo-700 transition duration-300">
                        Войти
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <button type="button" id="googleLoginBtn" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-full hover:bg-gray-300 transition duration-300">
                        Вход для администратора через Google
                    </button>
                </div>
                <p id="loadingIndicator" class="text-center mt-4 hidden">Загрузка...</p>
            </div>
        </div>

        <div id="dashboardSection" class="hidden">
            <nav class="flex justify-center space-x-4 mb-8">
                <button data-tab="lessons" class="dashboard-nav-btn bg-gray-200 text-gray-800 py-2 px-6 rounded-full font-semibold hover:bg-gray-300 transition duration-300">Мои уроки</button>
                <button data-tab="group" class="dashboard-nav-btn bg-gray-200 text-gray-800 py-2 px-6 rounded-full font-semibold hover:bg-gray-300 transition duration-300">Моя группа</button>
            </nav>

            <div id="dashboardContent">
                </div>
        </div>
        
        <div id="adminPanel" class="hidden">
            <nav class="flex justify-center space-x-2 md:space-x-4 mb-8 flex-wrap">
                <button data-tab="lessons" class="admin-nav-btn bg-gray-200 text-gray-800 py-2 px-6 rounded-full font-semibold hover:bg-gray-300 transition duration-300 mb-2">Уроки</button>
                <button data-tab="students" class="admin-nav-btn bg-gray-200 text-gray-800 py-2 px-6 rounded-full font-semibold hover:bg-gray-300 transition duration-300 mb-2">Студенты</button>
                <button data-tab="groups" class="admin-nav-btn bg-gray-200 text-gray-800 py-2 px-6 rounded-full font-semibold hover:bg-gray-300 transition duration-300 mb-2">Группы</button>
                <button data-tab="leads" class="admin-nav-btn bg-gray-200 text-gray-800 py-2 px-6 rounded-full font-semibold hover:bg-gray-300 transition duration-300 mb-2">Заявки</button>
                <button data-tab="customization" class="admin-nav-btn bg-gray-200 text-gray-800 py-2 px-6 rounded-full font-semibold hover:bg-gray-300 transition duration-300 mb-2">Кастомизация</button>
                <button data-tab="settings" class="admin-nav-btn bg-gray-200 text-gray-800 py-2 px-6 rounded-full font-semibold hover:bg-gray-300 transition duration-300 mb-2">Настройки</button>
            </nav>

            <div id="adminContent">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, getDoc, setDoc, getDocs, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Config
        const firebaseConfig = {
            apiKey: "AIzaSyB1FLSf6PBzNzb7_CWYH6Y0_--jhqO9MLQ",
            authDomain: "asonik-ai.firebaseapp.com",
            projectId: "asonik-ai",
            storageBucket: "asonik-ai.appspot.com",
            messagingSenderId: "875716508614",
            appId: "1:875716508614:web:ad264fdd60a20eb7dd90c7",
        };
        const DUMMY_EMAIL_DOMAIN = '@ya-buxgalter.local';

        // Firebase services
        let db, auth, storage;
        
        // State
        let userId, isUserAdmin = false;
        let allLessons = {};
        let studentTestResults = {};
        let lessonTestQuestions = 1;

        // --- DOM Elements ---
        const getEl = (id) => document.getElementById(id);
        const messageBox = getEl('messageBox');
        const app = getEl('app');
        
        // Sections
        const welcomeSection = getEl('welcomeSection');
        const coursesSection = getEl('coursesSection');
        const loginSection = getEl('loginSection');
        const dashboardSection = getEl('dashboardSection');
        const adminPanel = getEl('adminPanel');

        // Navigation
        const showHomeBtn = getEl('showHomeBtn');
        const showCoursesBtn = getEl('showCoursesBtn');
        const showLoginBtn = getEl('showLoginBtn');
        const showDashboardBtn = getEl('showDashboardBtn');
        const showAdminPanelBtn = getEl('showAdminPanelBtn');
        const userProfileDropdown = getEl('userProfileDropdown');
        const profileMenuButton = getEl('profileMenuButton');
        const profileMenu = getEl('profileMenu');
        const logoutBtn = getEl('logoutBtn');
        const dropdownShowProfileBtn = getEl('dropdownShowProfileBtn');
        
        // Welcome Section
        const welcomeCoursesBtn = getEl('welcomeCoursesBtn');
        const welcomeContactBtn = getEl('welcomeContactBtn');
        const mainPageCoursesContainer = getEl('mainPageCoursesContainer');

        // Login Section
        const loginForm = getEl('loginForm');
        const googleLoginBtn = getEl('googleLoginBtn');
        const loadingIndicator = getEl('loadingIndicator');
        
        // Lead Form
        const leadForm = getEl('leadForm');
        
        // Profile
        const userAvatar = getEl('userAvatar');

        // Logo
        const logoImg = getEl('logoImg');
        const logoText = getEl('logoText');
        
        // Theme Toggle
        const themeToggleBtn = getEl('themeToggleBtn');
        const themeIconSun = getEl('themeIconSun');
        const themeIconMoon = getEl('themeIconMoon');

        // --- UTILS ---
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = `fixed top-5 right-5 text-white px-4 py-2 rounded-lg shadow-lg z-[100] ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            setTimeout(() => { messageBox.className += ' hidden'; }, 3000);
        }

        function showSection(sectionId) {
            [welcomeSection, coursesSection, loginSection, dashboardSection, adminPanel].forEach(section => {
                if (section) section.classList.toggle('hidden', section.id !== sectionId);
            });
        }
        
        // --- THEME ---
        function applyTheme(theme) {
            document.body.classList.toggle('dark-theme', theme === 'dark');
            themeIconSun.classList.toggle('hidden', theme === 'dark');
            themeIconMoon.classList.toggle('hidden', theme !== 'dark');
        }

        themeToggleBtn.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        
        // --- NAVIGATION & UI FLOW ---
        function updateNavigationUI(isAuthenticated) {
            showLoginBtn.classList.toggle('hidden', isAuthenticated);
            showCoursesBtn.classList.toggle('hidden', isAuthenticated);
            userProfileDropdown.classList.toggle('hidden', !isAuthenticated);
            showDashboardBtn.classList.toggle('hidden', !isAuthenticated || isUserAdmin);
            showAdminPanelBtn.classList.toggle('hidden', !isUserAdmin);
        }

        showHomeBtn.addEventListener('click', () => showSection('welcomeSection'));
        showCoursesBtn.addEventListener('click', () => showSection('coursesSection'));
        welcomeCoursesBtn.addEventListener('click', () => showSection('coursesSection'));
        showLoginBtn.addEventListener('click', () => showSection('loginSection'));
        showAdminPanelBtn.addEventListener('click', () => showSection('adminPanel'));
        showDashboardBtn.addEventListener('click', () => showSection('dashboardSection'));
        
        profileMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            profileMenu.classList.toggle('hidden');
        });
        window.addEventListener('click', () => profileMenu.classList.add('hidden'));

        // --- FIREBASE INITIALIZATION & AUTH STATE ---
        window.onload = () => {
            try {
                const firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);
                storage = getStorage(firebaseApp);
                console.log('Firebase initialized.');
                
                applyTheme(localStorage.getItem('theme') || 'light');
                loadMainInfo();
                loadCoursesForMainPage();
                loadCoursesForLeadForm();

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        const adminDocSnap = await getDoc(doc(db, 'admin_users', user.uid));
                        isUserAdmin = adminDocSnap.exists() && adminDocSnap.data().isAdmin;
                        
                        updateNavigationUI(true);
                        
                        if (isUserAdmin) {
                            showSection('adminPanel');
                            handleAdminNav('lessons'); // Open lessons tab by default
                        } else {
                            await loadStudentInfo();
                            showSection('dashboardSection');
                            handleDashboardNav('lessons'); // Open lessons tab by default
                        }
                    } else {
                        userId = null;
                        isUserAdmin = false;
                        updateNavigationUI(false);
                        showSection('welcomeSection');
                    }
                });
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showMessage('Ошибка инициализации приложения.', true);
            }
        };

        // --- AUTHENTICATION LOGIC ---
        logoutBtn.addEventListener('click', () => signOut(auth).catch(e => showMessage('Ошибка выхода.', true)));
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const login = loginForm.loginEmail.value;
            const password = loginForm.loginPassword.value;
            if (!login || !password) return showMessage("Заполните все поля.", true);

            loadingIndicator.classList.remove('hidden');
            try {
                const email = login.includes('@') ? login : login + DUMMY_EMAIL_DOMAIN;
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showMessage('Ошибка входа. Проверьте логин и пароль.', true);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });
        
        googleLoginBtn.addEventListener('click', async () => {
            loadingIndicator.classList.remove('hidden');
            try {
                const result = await signInWithPopup(auth, new GoogleAuthProvider());
                const adminDocSnap = await getDoc(doc(db, 'admin_users', result.user.uid));
                if (!adminDocSnap.exists() || !adminDocSnap.data().isAdmin) {
                    await signOut(auth);
                    showMessage('Вход отклонён. Вы не администратор.', true);
                }
            } catch (error) {
                showMessage('Ошибка входа через Google.', true);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });
        
        // --- TEMPLATES & DYNAMIC CONTENT ---
        const templates = {
            // Templates for each section will go here
        };

        // --- DASHBOARD LOGIC ---
        document.querySelector('#dashboardSection nav').addEventListener('click', (e) => {
            if (e.target.matches('.dashboard-nav-btn')) {
                handleDashboardNav(e.target.dataset.tab);
            }
        });

        async function handleDashboardNav(tabName) {
            document.querySelectorAll('.dashboard-nav-btn').forEach(btn => {
                btn.classList.toggle('bg-indigo-500', btn.dataset.tab === tabName);
                btn.classList.toggle('text-white', btn.dataset.tab === tabName);
                btn.classList.toggle('bg-gray-200', btn.dataset.tab !== tabName);
                btn.classList.toggle('text-gray-800', btn.dataset.tab !== tabName);
            });
            
            const contentArea = getEl('dashboardContent');
            contentArea.innerHTML = '<p>Загрузка...</p>'; // Loading indicator
            
            // Render content based on tab
            switch(tabName) {
                case 'lessons':
                    contentArea.innerHTML = `
                        <div id="dashboardLessonsSection">
                             <h2 class="text-3xl font-bold text-center mb-8">Мои уроки</h2>
                             <div id="lessonsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        </div>
                        <div id="lessonViewSection" class="hidden">
                             <button id="backToLessonsBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-full hover:bg-gray-300 transition duration-300 mb-6">&larr; Назад к урокам</button>
                             <div id="lessonDetailsContainer"></div>
                        </div>`;
                    loadLessons();
                    break;
                case 'group':
                    contentArea.innerHTML = `
                        <h2 class="text-3xl font-bold text-center mb-8">Моя группа</h2>
                        <div class="max-w-4xl mx-auto">
                            <div class="overflow-x-auto bg-card-bg-color rounded-lg shadow-md"><table class="min-w-full"><thead class="bg-gray-200 dark:bg-gray-600"><tr id="groupTableHead"></tr></thead><tbody id="groupMembersList"></tbody></table></div>
                        </div>`;
                    loadMyGroup();
                    break;
                case 'profile':
                    contentArea.innerHTML = `
                        <h2 class="text-3xl font-bold text-center mb-8">Мой профиль</h2>
                        <div class="max-w-2xl mx-auto bg-card-bg-color p-6 rounded-lg shadow-md border dark:border-gray-700">
                            <div class="flex flex-col items-center mb-4">
                                <img id="profileAvatar" src="https://placehold.co/128x128" alt="Аватар" class="rounded-full w-32 h-32 mb-4"><button id="changeAvatarBtn" class="bg-blue-500 text-white py-2 px-4 rounded-full text-sm hover:bg-blue-600">Изменить аватар</button><input type="file" id="avatarFileInput" accept="image/*" class="hidden">
                            </div>
                            <div class="text-center space-y-2">
                                <p><strong>ФИО:</strong> <span id="profileFIO"></span></p>
                                <p><strong>Логин:</strong> <span id="profileEmailDisplay"></span></p>
                                <p><strong>Год рождения:</strong> <span id="profileBirthYearDisplay"></span></p>
                                <p><strong>Группа:</strong> <span id="profileGroupDisplay"></span></p>
                            </div>
                        </div>`;
                    loadProfileData();
                    break;
            }
        }

        dropdownShowProfileBtn.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('dashboardSection');
            handleDashboardNav('profile');
        });

        // --- ADMIN PANEL LOGIC ---
        document.querySelector('#adminPanel nav').addEventListener('click', (e) => {
            if (e.target.matches('.admin-nav-btn')) {
                handleAdminNav(e.target.dataset.tab);
            }
        });

        async function handleAdminNav(tabName) {
            document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                btn.classList.toggle('bg-indigo-500', btn.dataset.tab === tabName);
                btn.classList.toggle('text-white', btn.dataset.tab === tabName);
                btn.classList.toggle('bg-gray-200', btn.dataset.tab !== tabName);
                btn.classList.toggle('text-gray-800', btn.dataset.tab !== tabName);
            });

            const contentArea = getEl('adminContent');
            contentArea.innerHTML = '<p>Загрузка...</p>'; // Loading indicator

            switch(tabName) {
                case 'lessons':
                    contentArea.innerHTML = `...`; // HTML for lessons admin
                    // loadAdminLessons();
                    break;
                // Add cases for 'students', 'groups', 'leads', etc.
                 case 'students':
                    contentArea.innerHTML = `...`; // HTML for students admin
                    // loadAdminStudents();
                    break;
                 default:
                    contentArea.innerHTML = `<p class="text-center">Раздел в разработке.</p>`;
            }
             // NOTE: For brevity, the full HTML templates for each admin section are omitted here, but would be inserted in a full implementation.
        }

        // --- DATA LOADING FUNCTIONS ---
        async function loadStudentInfo() {
            if (!userId) return;
            const docSnap = await getDoc(doc(db, 'students', userId));
            if (docSnap.exists()) {
                const data = docSnap.data();
                userAvatar.src = data.avatarUrl || 'https://placehold.co/32x32';
                studentTestResults = data.testResults || {};
            }
        }
        
        async function loadMainInfo() {
            const docSnap = await getDoc(doc(db, 'mainInfo', 'main'));
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.siteLogoText) logoText.textContent = data.siteLogoText;
                if (data.siteLogoUrl) logoImg.src = data.siteLogoUrl;
            }
        }
        
        async function loadCoursesForMainPage() {
            const coursesRef = collection(db, 'courseInfo');
            const snapshot = await getDocs(coursesRef);
            mainPageCoursesContainer.innerHTML = snapshot.docs.map(docSnap => {
                const data = docSnap.data();
                return `<div class="bg-card-bg-color/20 text-white rounded-lg p-6 shadow-md transform transition hover:scale-105 backdrop-blur-sm">
                            <h4 class="text-2xl font-bold mb-3">${data.title}</h4>
                            <p>${data.description}</p>
                        </div>`;
            }).join('');
        }

        async function loadCoursesForLeadForm() {
            const select = getEl('leadCourseType');
            const coursesRef = collection(db, 'courseInfo');
            const snapshot = await getDocs(coursesRef);
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const option = document.createElement('option');
                option.value = data.title;
                option.textContent = data.title;
                select.appendChild(option);
            });
        }
        
        function loadLessons() {
            const lessonsRef = collection(db, "lessons");
            const lessonsContainer = getEl('lessonsContainer');
            if (!lessonsContainer) return;

            onSnapshot(lessonsRef, (snapshot) => {
                lessonsContainer.innerHTML = ''; // Clear previous lessons
                allLessons = {};
                const sortedLessons = snapshot.docs.sort((a, b) => (a.data().createdAt?.toDate() || 0) - (b.data().createdAt?.toDate() || 0));

                sortedLessons.forEach((docSnap, index) => {
                    const lesson = docSnap.data();
                    const lessonId = docSnap.id;
                    allLessons[lessonId] = lesson;
                    
                    const userScore = studentTestResults[lessonId];
                    const progressColor = userScore >= 80 ? '#22c55e' : (userScore > 0 ? '#f59e0b' : '#ef4444');
                    const progressValue = userScore / 100 || 0;
                    const circumference = 2 * Math.PI * 22;
                    const progressDashoffset = circumference * (1 - progressValue);

                    const isUnlocked = index === 0 || studentTestResults[sortedLessons[index - 1].id] >= 80;

                    const lessonCard = document.createElement('div');
                    lessonCard.className = `bg-card-bg-color rounded-lg shadow-md overflow-hidden transform transition duration-300 ${isUnlocked ? 'hover:scale-105 cursor-pointer' : 'opacity-60'}`;
                    if (isUnlocked) lessonCard.dataset.lessonId = lessonId;
                    
                    lessonCard.innerHTML = `
                        ${!isUnlocked ? '<div class="absolute inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center text-white text-xl font-bold z-10">🔒</div>' : ''}
                        ${lesson.imageUrl ? `<img src="${lesson.imageUrl}" alt="${lesson.title}" class="w-full h-48 object-cover">` : ''}
                        <div class="p-6 relative">
                            <h4 class="text-xl font-bold mb-2 pr-14">${lesson.title}</h4>
                            <p class="text-text-color/70 text-sm">${lesson.description}</p>
                            <div class="absolute top-4 right-4 flex items-center justify-center progress-circle" style="--progress-color: ${progressColor};">
                                <svg class="w-12 h-12">
                                    <circle class="bg" cx="24" cy="24" r="22" stroke-width="4"></circle>
                                    <circle class="progress" cx="24" cy="24" r="22" stroke-width="4" stroke-dasharray="${circumference}" stroke-dashoffset="${progressDashoffset}"></circle>
                                </svg>
                                <span class="absolute text-sm font-bold">${userScore !== undefined ? `${userScore.toFixed(0)}%` : '0%'}</span>
                            </div>
                            ${!isUnlocked ? '<p class="mt-4 text-xs text-red-500">Пройдите предыдущий урок на 80%</p>' : ''}
                        </div>`;
                    lessonsContainer.appendChild(lessonCard);
                });
            });
        }
        
        async function loadProfileData() {
            if (!userId) return;
            const studentRef = doc(db, 'students', userId);
            const docSnap = await getDoc(studentRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                getEl('profileFIO').textContent = `${data.name} ${data.lastName}`;
                getEl('profileEmailDisplay').textContent = data.email.replace(DUMMY_EMAIL_DOMAIN, '');
                getEl('profileBirthYearDisplay').textContent = data.birthYear || 'Неизвестно';
                getEl('profileGroupDisplay').textContent = data.group || 'Неизвестно';
                getEl('profileAvatar').src = data.avatarUrl || 'https://placehold.co/128x128';
            }
        }
        
        async function loadMyGroup() {
            // Functionality for loading and displaying group members
        }


        // --- EVENT LISTENERS ---
        // Note: Additional event listeners for forms and buttons would be here.
        // For example, listener for lesson card clicks.
        document.addEventListener('click', e => {
            const lessonCard = e.target.closest('[data-lesson-id]');
            if (lessonCard) {
                // handle lesson view logic
                showMessage(`Открываю урок: ${allLessons[lessonCard.dataset.lessonId].title}`);
            }

            if (e.target.matches('#changeAvatarBtn')) {
                getEl('avatarFileInput').click();
            }
        });

    </script>
</body>
</html>
