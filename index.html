<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="site-title-tag">Система Учёта</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --bg-main: #f7f7f9;
            --bg-card: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --header-brand: #2563eb;
            --bg-hover: #f3f4f6;
        }

        .theme-violet {
            --bg-main-start: #a78bfa; 
            --bg-main-end: #ddd6fe;
            --bg-card: rgba(255, 255, 255, 0.4);
            --text-primary: #1e1b4b;
            --text-secondary: #4338ca;
            --border-color: rgba(99, 102, 241, 0.3);
            --header-brand: #4338ca;
            --bg-hover: rgba(255, 255, 255, 0.6);
        }

        .theme-crimson {
            --bg-main-start: #fb7185;
            --bg-main-end: #fecdd3;
            --bg-card: rgba(255, 255, 255, 0.4);
            --text-primary: #881337;
            --text-secondary: #be123c;
            --border-color: rgba(225, 29, 72, 0.3);
            --header-brand: #be123c;
            --bg-hover: rgba(255, 255, 255, 0.6);
        }
        
        .theme-sunset {
            --bg-main-start: #fb923c;
            --bg-main-end: #fed7aa;
            --bg-card: rgba(255, 255, 255, 0.4);
            --text-primary: #7c2d12;
            --text-secondary: #c2410c;
            --border-color: rgba(234, 88, 12, 0.3);
            --header-brand: #c2410c;
            --bg-hover: rgba(255, 255, 255, 0.6);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.5s ease;
        }

        body.theme-violet, body.theme-crimson, body.theme-sunset {
            background-image: linear-gradient(135deg, var(--bg-main-start), var(--bg-main-end));
        }

        .card, .bg-white, .bg-gray-50 {
            background-color: var(--bg-card);
            border-color: var(--border-color);
        }
        .text-gray-900, .text-gray-800, .text-gray-700 { color: var(--text-primary); }
        .text-gray-600, .text-gray-500, .text-gray-400 { color: var(--text-secondary); }
        .border-b, .border { border-color: var(--border-color); }
        .hover\:bg-gray-100:hover, .hover\:bg-gray-50:hover { background-color: var(--bg-hover); }

        .min-h-h-screen { min-height: calc(100vh - 32px); }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); z-index: 40; }
        #transaction-modal, #edit-client-modal, #dist-item-modal, #dist-recipient-modal { z-index: 50; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        
        .theme-btn.active { box-shadow: 0 0 0 2px var(--header-brand); }
        
        .theme-violet .modal-overlay .card,
        .theme-crimson .modal-overlay .card,
        .theme-sunset .modal-overlay .card {
             background-color: #1f2937;
             color: #f9fafb;
        }
         .theme-violet .modal-overlay .bg-transparent,
         .theme-crimson .modal-overlay .bg-transparent,
         .theme-sunset .modal-overlay .bg-transparent {
            background-color: rgba(255, 255, 255, 0.05);
         }
        mark { background-color: #fde047; color: black; padding: 0 2px; border-radius: 2px; }
        .sub-table td { transition: all 0.3s ease-in-out; }

        #distribution-table input {
            border: 1px solid transparent;
            text-align: center;
        }
        #distribution-table input:focus {
            border-color: var(--header-brand);
            box-shadow: 0 0 0 1px var(--header-brand);
        }
        #distribution-table th, #distribution-table td {
            white-space: nowrap;
            padding: 8px 12px;
        }
        .editable-header { cursor: pointer; }
        .editable-header:hover { background-color: var(--bg-hover); }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="login-screen" class="w-full max-w-md bg-white p-10 rounded-xl card flex-col items-center justify-center transition-all duration-300 hidden">
        <img id="login-logo" src="" alt="Logo" class="h-20 mb-6 hidden">
        <h1 class="text-3xl font-bold mb-2 text-center" id="login-title">Добро пожаловать</h1>
        <p class="text-center text-gray-600 mb-8">Войдите, чтобы получить доступ к вашим данным.</p>
        <button id="google-signin-button" class="w-full flex items-center justify-center bg-white border border-gray-300 text-gray-700 font-semibold py-3 px-4 rounded-lg shadow-sm hover:bg-gray-50 transition duration-200">
            <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23 7.9 1L48 0v48H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z"/></svg>
            Войти с помощью Google
        </button>
        <p id="login-error" class="text-red-500 mt-4 text-sm"></p>
    </div>
    <div id="access-denied-screen" class="hidden w-full max-w-md bg-white p-10 rounded-xl card flex flex-col items-center justify-center text-center">
        <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
        <h1 class="text-2xl font-bold mb-2">Доступ запрещен</h1>
        <p class="text-gray-600 mb-2">Вы вошли как <strong id="user-email-display"></strong>. Эта учетная запись не имеет прав администратора.</p>
        <p class="text-xs text-gray-500 mb-6">Скопируйте этот ID и вставьте его в код: <code id="denied-user-uid" class="bg-gray-200 p-1 rounded select-all font-mono"></code></p>
        <button id="access-denied-logout-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-sm transition duration-200">
            Выйти
        </button>
    </div>

    <div id="main-menu-screen" class="hidden w-full max-w-6xl">
        <div class="p-8 rounded-xl card text-center">
             <img id="menu-logo" src="" alt="Logo" class="h-24 mx-auto mb-6 hidden">
             <h1 id="menu-title" class="text-4xl font-bold mb-4">Главное Меню</h1>
             <p class="text-lg text-gray-600 mb-10">Выберите раздел для работы</p>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                 <button id="goto-sales-btn" class="flex flex-col items-center justify-center p-8 bg-blue-50 hover:bg-blue-100 rounded-2xl transition-all duration-300 transform hover:scale-105">
                     <svg class="w-20 h-20 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182.553-.44 1.278-.659 2.003-.659c.768 0 1.536.219 2.121.659L15 9.182" />
                     </svg>
                     <h2 class="text-2xl font-bold">Продажи</h2>
                     <p class="text-gray-500 mt-1">Учёт клиентов и транзакций</p>
                 </button>
                 <button id="goto-purchases-btn" class="flex flex-col items-center justify-center p-8 bg-green-50 hover:bg-green-100 rounded-2xl transition-all duration-300 transform hover:scale-105">
                     <svg class="w-20 h-20 text-green-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c.51 0 .962-.328 1.093-.826l1.821-6.831c.13-.483-.046-.996-.433-1.293a1.846 1.846 0 0 0-1.094-.373H5.21M7.5 14.25 6.108 5.166" />
                     </svg>
                     <h2 class="text-2xl font-bold">Покупки</h2>
                     <p class="text-gray-500 mt-1">Учёт поставщиков и закупок</p>
                 </button>
                 <button id="goto-distribution-btn" class="flex flex-col items-center justify-center p-8 bg-indigo-50 hover:bg-indigo-100 rounded-2xl transition-all duration-300 transform hover:scale-105">
                    <svg class="w-20 h-20 text-indigo-500 mb-4" xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
                    </svg>
                     <h2 class="text-2xl font-bold">Распределение</h2>
                     <p class="text-gray-500 mt-1">Таблица распределения товаров</p>
                 </button>
             </div>
        </div>
    </div>
    
    <div id="main-app-screen" class="hidden w-full max-w-7xl mx-auto flex-col min-h-h-screen bg-white rounded-xl card transition-all duration-300 p-6 md:p-8">
        <header class="flex items-center justify-between border-b pb-4 mb-4">
            </header>
        <section id="view-clients" class="view-content flex flex-col flex-grow pt-4">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold" data-lang-key="main_header">ОСНОВА</h2></div>
            <div id="controls-container" class="flex flex-col md:flex-row gap-3 mb-4">
                <input type="text" id="client-search" placeholder="Поиск..." class="flex-grow px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-transparent" data-lang-key="search_placeholder">
                <select id="client-sort" class="px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-transparent card"><option value="newest" data-lang-key="sort_newest"></option><option value="oldest" data-lang-key="sort_oldest"></option><option value="name_az" data-lang-key="sort_name_az"></option><option value="name_za" data-lang-key="sort_name_za"></option></select>
                <button id="add-transaction-button" class="font-semibold py-2.5 px-4 rounded-lg shadow-md flex items-center justify-center text-white"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg><span data-lang-key="add_transaction"></span></button>
            </div>
            <div id="clients-list-container" class="overflow-y-auto flex-grow space-y-4"></div>
        </section>
        <section id="view-details" class="view-content hidden flex-col flex-grow pt-4"><div id="details-view-container"></div></section>
        <section id="view-settings" class="view-content hidden flex-col flex-grow pt-4 px-4">
            </section>
    </div>

    <div id="distribution-screen" class="hidden w-full max-w-7xl mx-auto flex-col min-h-h-screen bg-white rounded-xl card transition-all duration-300 p-6 md:p-8">
         <header class="flex items-center justify-between border-b pb-4 mb-4">
            <div class="flex items-center space-x-3">
                 <button id="dist-back-to-menu-btn" title="Главное меню" class="p-2 rounded-md hover:bg-gray-100 transition duration-150 card">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </button>
                <h1 class="text-3xl font-bold" style="color: var(--header-brand);">Распределение</h1>
            </div>
         </header>
         <div class="flex items-center space-x-4 mb-4">
            <button id="add-dist-item-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Добавить товар</button>
            <button id="manage-dist-recipients-btn" class="bg-gray-200 hover:bg-gray-300 font-semibold py-2 px-4 rounded-lg">Управлять получателями</button>
         </div>
         <div class="overflow-x-auto">
            <table id="distribution-table" class="min-w-full text-sm border-collapse">
                <thead></thead>
                <tbody></tbody>
            </table>
         </div>
    </div>

    <div id="transaction-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden"> </div>
    <div id="edit-client-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden"> </div>

    <div id="dist-item-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
         <div class="bg-white w-full max-w-md p-6 rounded-xl card">
              <h2 id="dist-item-modal-title" class="text-2xl font-bold mb-4">Добавить товар</h2>
              <form id="dist-item-form"><input type="hidden" id="dist-item-id">
                   <div><label for="dist-item-name-input" class="block text-sm font-medium">Название товара</label><input type="text" id="dist-item-name-input" required class="w-full mt-1 px-4 py-2 border rounded-lg bg-transparent"></div>
                   <div class="flex justify-between items-center pt-6">
                        <button type="button" id="dist-item-delete-btn" class="px-5 py-2.5 text-red-600 hover:bg-red-50 font-semibold rounded-lg hidden">Удалить</button>
                        <div>
                            <button type="button" id="dist-item-modal-close-btn" class="px-5 py-2.5 bg-gray-200 font-semibold rounded-lg mr-2">Отмена</button>
                            <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg">Сохранить</button>
                        </div>
                   </div>
              </form>
         </div>
    </div>
    <div id="dist-recipient-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
         <div class="bg-white w-full max-w-md p-6 rounded-xl card">
              <h2 id="dist-recipient-modal-title" class="text-2xl font-bold mb-4">Добавить получателя</h2>
              <form id="dist-recipient-form"><input type="hidden" id="dist-recipient-id">
                   <div><label for="dist-recipient-name-input" class="block text-sm font-medium">Имя получателя</label><input type="text" id="dist-recipient-name-input" required class="w-full mt-1 px-4 py-2 border rounded-lg bg-transparent"></div>
                   <div class="flex justify-between items-center pt-6">
                        <button type="button" id="dist-recipient-delete-btn" class="px-5 py-2.5 text-red-600 hover:bg-red-50 font-semibold rounded-lg hidden">Удалить</button>
                        <div>
                            <button type="button" id="dist-recipient-modal-close-btn" class="px-5 py-2.5 bg-gray-200 font-semibold rounded-lg mr-2">Отмена</button>
                            <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg">Сохранить</button>
                        </div>
                   </div>
              </form>
         </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, updateDoc, deleteDoc, onSnapshot, writeBatch, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ===
        const ADMIN_UIDS = ['h25tlwhyAQfo1PBgzYmekWKD5Vl1'];
        const CUSTOM_FIREBASE_CONFIG = {"apiKey":"AIzaSyB1FLSf6PBzNzb7_CWYH6Y0_--jhqO9MLQ","authDomain":"asonik-ai.firebaseapp.com","projectId":"asonik-ai","storageBucket":"asonik-ai.firebasestorage.app","messagingSenderId":"875716508614","appId":"1:875716508614:web:ad264fdd60a20eb7dd90c7","measurementId":"G-HT5T20YPVE"};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : CUSTOM_FIREBASE_CONFIG;
        
        let db, auth, currentUserId;
        let unsubscribeDataListener = null;
        let entityAggregates = {};
        let allTransactions = [];
        let currentEntityDetailsId = null;
        let currentMode = 'sales';

        // Translations object remains the same
        const translations = {
            ru: {
                russian: "Русский", turkish: "Türkçe", loading: "Загрузка системы...", 
                nav_details: "ПОДРОБНО", nav_settings: "НАСТРОЙКИ",
                settings_title: "Настройки Системы", settings_theme_title: "Тема оформления", 
                theme_light: "Светлая", theme_violet: "Фиолетовая", theme_crimson: "Багровая", theme_sunset: "Закат",
                settings_logo_title: "Логотип", logo_uploading: "Загрузка...", logo_upload_success: "Логотип успешно загружен!", logo_upload_error: "Ошибка загрузки.",
                settings_app_name_title: "Название Приложения", settings_app_name_label: "Изменить название",
                settings_account_title: "Ваша Учётная Запись", status: "Статус", user_id: "ID Пользователя",
                cancel: "Отмена", save: "Сохранить", edit: "Ред.", delete: "Удал.", details_btn: "Выбрать",
                sort_newest: "Сначала новые", sort_oldest: "Сначала старые", sort_name_az: "Имя (А-Я)", sort_name_za: "Имя (Я-А)",
                date: "Дата", item: "Товар/Описание", amount: "Сумма", paid: "Касса", running_balance: "Итоговый Остаток", actions: "Действия",
                item_name: "Товар / Описание", unit_price: "Цена за ед.", quantity: "Кол-во", payment_received: "Касса ($)",
                initial_balance: "Начальный остаток ($)", transaction_date: "Дата Транзакции",
                export_to_excel: "Экспорт в Excel", reset_filters: "Сброс", search_item_placeholder: "Поиск по товару...",
                item_list: "Список товаров", add_item_btn: "Добавить товар", remove_item_btn: "Удалить",
                sales: {
                    nav_main: "ПРОДАЖИ", main_header: "ОСНОВА (Обзор Клиентов)", edit_client: "Редактировать Клиента", delete_client: "Удалить Клиента", 
                    search_placeholder: "Поиск по имени клиента...", add_transaction: "Добавить Продажу",
                    details_placeholder_title: "Клиент не выбран", details_placeholder_text: "Пожалуйста, выберите клиента, чтобы просмотреть его детали.",
                    details_list_title: "ПОДРОБНО (Выбор Клиента)", details_list_text: "Выберите клиента из списка ниже.",
                    modal_add_trans_title: "Добавить Новую Продажу", modal_edit_trans_title: "Редактировать Продажу",
                    client_name: "Имя Клиента", new_client_placeholder: "Введите имя нового клиента", add_new_client_btn: "Добавить нового клиента", back_to_list_btn: "Вернуться к списку",
                    edit_client_title: "Редактировать имя клиента", new_name_label: "Новое имя клиента",
                    details_title: "Подробная информация о клиенте", total_sales: "Всего Продано", total_paid: "Всего (Касса)", total_remaining: "Полный Остаток",
                    transaction_history: "История Транзакций", back_to_clients: "Назад к списку клиентов",
                    confirm_delete_transaction: "Вы уверены, что хотите удалить эту транзакцию?", confirm_delete_client: "ВНИМАНИЕ! Вы действительно хотите удалить клиента и ВСЕ его транзакции? Это действие необратимо.",
                },
                purchases: {
                    nav_main: "ПОКУПКИ", main_header: "ОСНОВА (Обзор Поставщиков)", edit_client: "Редактировать Поставщика", delete_client: "Удалить Поставщика", 
                    search_placeholder: "Поиск по имени поставщика...", add_transaction: "Добавить Закупку",
                    details_placeholder_title: "Поставщик не выбран", details_placeholder_text: "Пожалуйста, выберите поставщика, чтобы просмотреть его детали.",
                    details_list_title: "ПОДРОБНО (Выбор Поставщика)", details_list_text: "Выберите поставщика из списка ниже.",
                    modal_add_trans_title: "Добавить Новую Закупку", modal_edit_trans_title: "Редактировать Закупку",
                    client_name: "Имя Поставщика", new_client_placeholder: "Введите имя нового поставщика", add_new_client_btn: "Добавить нового поставщика", back_to_list_btn: "Вернуться к списку",
                    edit_client_title: "Редактировать имя поставщика", new_name_label: "Новое имя поставщика",
                    details_title: "Подробная информация о поставщике", total_sales: "Всего Закуплено", total_paid: "Всего Оплачено", total_remaining: "Полный Долг",
                    transaction_history: "История Закупок", back_to_clients: "Назад к списку поставщиков",
                    confirm_delete_transaction: "Вы уверены, что хотите удалить эту закупку?", confirm_delete_client: "ВНИМАНИЕ! Вы действительно хотите удалить поставщика и ВСЕ его закупки? Это действие необратимо.",
                }
            },
            tr: { /* Turkish translations */ }
        };

        let currentLang = 'ru';

        // *** ALL HELPER AND SETUP FUNCTIONS remain largely the same, but with the backward compatibility fix added to startDataListener ***

        // Data processing now includes a backward compatibility check
        function startDataListener() {
            if (unsubscribeDataListener) unsubscribeDataListener();
            const collectionRef = getCollectionRef();
            if (!collectionRef) return;
            unsubscribeDataListener = onSnapshot(collectionRef, (snapshot) => {
                allTransactions = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // *** BACKWARD COMPATIBILITY FIX ***
                    if (!data.items) {
                        data.items = [{ itemName: data.itemName || 'N/A', unitPrice: data.unitPrice || 0, quantity: data.quantity || 0 }];
                        data.totalAmount = (data.unitPrice || 0) * (data.quantity || 0);
                    }
                    if (typeof data.totalAmount === 'undefined') {
                         data.totalAmount = data.items.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
                    }
                    return { ...data, id: doc.id, transactionDate: data.transactionDate.toDate() };
                });

                // The rest of the function is the same
                entityAggregates = {};
                allTransactions.forEach(t => { if (!entityAggregates[t.clientId]) entityAggregates[t.clientId] = { name: t.clientName, transactions: [] }; entityAggregates[t.clientId].transactions.push(t); });
                Object.keys(entityAggregates).forEach(clientId => { const client = entityAggregates[clientId]; client.transactions.sort((a, b) => a.transactionDate - b.transactionDate); client.totalSales = client.transactions.reduce((sum, t) => sum + (t.totalAmount || 0), 0); client.totalPaid = client.transactions.reduce((sum, t) => sum + (t.paymentReceived || 0), 0); });
                renderMainList();
                const activeNavItem = document.querySelector('.header-nav-item[style*="var(--header-brand)"]');
                if (activeNavItem && activeNavItem.dataset.view === 'details') renderDetailsView();
            });
        }
        
        // renderDetailedEntityInfo now includes the CALENDAR/DATE FILTERS
        function renderDetailedEntityInfo(container, entityId) {
            const entity = entityAggregates[entityId];
            const remaining = entity.totalSales - entity.totalPaid;
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <div class="flex items-center space-x-4"><button class="flex items-center space-x-2 px-4 py-2 rounded-lg hover:bg-gray-100 card font-semibold" onclick="window.backToDetailsList()"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg><span data-lang-key="back_to_clients"></span></button><h2 class="text-3xl font-bold">${entity.name}</h2></div>
                    <div class="flex items-center space-x-2"><button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center space-x-2" onclick="window.exportClientToExcel('${entityId}')"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span data-lang-key="export_to_excel"></span></button><button class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg" onclick="window.openEditClientNameModal('${entityId}', '${entity.name.replace(/'/g, "\\'")}')"><span data-lang-key="edit_client"></span></button><button class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg" onclick="window.deleteClient('${entityId}')"><span data-lang-key="delete_client"></span></button></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div class="p-4 rounded-lg bg-blue-50 card"><p class="text-sm text-blue-800" data-lang-key="total_sales"></p><p class="text-2xl font-bold text-blue-900 mt-1">${formatCurrency(entity.totalSales)}</p></div><div class="p-4 rounded-lg bg-green-50 card"><p class="text-sm text-green-800" data-lang-key="total_paid"></p><p class="text-2xl font-bold text-green-900 mt-1">${formatCurrency(entity.totalPaid)}</p></div><div class="p-4 rounded-lg bg-red-50 card"><p class="text-sm text-red-800" data-lang-key="total_remaining"></p><p class="text-2xl font-bold text-red-900 mt-1">${formatCurrency(remaining)}</p></div></div>
                <div class="flex flex-wrap items-center gap-4 mb-3 p-3 border rounded-lg card">
                    <h3 class="text-lg font-semibold w-full sm:w-auto" data-lang-key="transaction_history"></h3>
                    <input type="text" id="details-transaction-search" class="flex-grow px-3 py-1.5 border rounded-lg bg-transparent" data-lang-key="search_item_placeholder">
                    <select id="details-sort-order" class="px-3 py-1.5 border rounded-lg bg-transparent card"><option value="newest" data-lang-key="sort_newest"></option><option value="oldest" data-lang-key="sort_oldest"></option></select>
                    <div class="flex items-center gap-2"><input type="date" id="details-start-date" class="px-3 py-1.5 border rounded-lg bg-transparent card"><span class="text-gray-500">-</span><input type="date" id="details-end-date" class="px-3 py-1.5 border rounded-lg bg-transparent card"></div>
                    <button id="details-filter-reset" class="px-4 py-1.5 border rounded-lg bg-transparent hover:bg-gray-100 card font-semibold" data-lang-key="reset_filters"></button>
                </div>
                <div class="rounded-lg border overflow-x-auto card"><table class="min-w-full divide-y"><thead class="bg-gray-50"><tr class="text-xs font-semibold uppercase"><th class="px-2 py-3 text-left" data-lang-key="date"></th><th class="px-2 py-3 text-left" data-lang-key="item"></th><th class="px-2 py-3 text-right" data-lang-key="amount"></th><th class="px-2 py-3 text-right" data-lang-key="paid"></th><th class="px-2 py-3 text-right" data-lang-key="running_balance"></th><th class="px-2 py-3 text-center" data-lang-key="actions"></th></tr></thead><tbody id="transactions-table-body" class="divide-y"></tbody></table></div>`;
            
            const applyFilters = () => renderTransactionsTable(entityId, document.getElementById('details-transaction-search').value, document.getElementById('details-sort-order').value, document.getElementById('details-start-date').value, document.getElementById('details-end-date').value);
            applyFilters(); 
            document.getElementById('details-transaction-search').addEventListener('input', applyFilters);
            document.getElementById('details-sort-order').addEventListener('change', applyFilters);
            document.getElementById('details-start-date').addEventListener('change', applyFilters);
            document.getElementById('details-end-date').addEventListener('change', applyFilters);
            document.getElementById('details-filter-reset').addEventListener('click', () => { document.getElementById('details-transaction-search').value = ''; document.getElementById('details-sort-order').value = 'newest'; document.getElementById('details-start-date').value = ''; document.getElementById('details-end-date').value = ''; applyFilters(); });
            setLanguage(currentLang);
        }

        // *** NEW DISTRIBUTION FUNCTIONS ***
        const getDistItemsRef = () => collection(db, 'artifacts', appId, 'users', currentUserId, 'dist_items');
        const getDistRecipientsRef = () => collection(db, 'artifacts', appId, 'users', currentUserId, 'dist_recipients');
        const getDistDataRef = () => collection(db, 'artifacts', appId, 'users', currentUserId, 'dist_data');

        async function renderDistributionView() {
            const [itemsSnap, recipientsSnap, dataSnap] = await Promise.all([getDocs(getDistItemsRef()), getDocs(getDistRecipientsRef()), getDocs(getDistDataRef())]);
            const items = itemsSnap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.name.localeCompare(b.name));
            const recipients = recipientsSnap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.name.localeCompare(b.name));
            const distData = new Map(dataSnap.docs.map(d => [d.id, d.data()]));

            const table = document.getElementById('distribution-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Build header
            let headerRow = '<tr><th class="border p-2">Товар</th>';
            recipients.forEach(r => { headerRow += `<th class="border p-2 editable-header" data-recipient-id="${r.id}" title="Редактировать">${r.name}</th>`; });
            headerRow += '</tr>';
            thead.innerHTML = headerRow;

            // Build body
            items.forEach(item => {
                let bodyRow = `<tr><td class="border p-2 font-semibold editable-header" data-item-id="${item.id}" title="Редактировать">${item.name}</td>`;
                const itemData = distData.get(item.id) || {};
                recipients.forEach(recipient => {
                    const qty = itemData[recipient.id] || '';
                    bodyRow += `<td class="border p-0"><input type="number" class="w-24 h-full p-2 bg-transparent rounded-none" data-item-id="${item.id}" data-recipient-id="${recipient.id}" value="${qty}"></td>`;
                });
                bodyRow += '</tr>';
                tbody.innerHTML += bodyRow;
            });
            
            // Add event listeners
            tbody.querySelectorAll('input').forEach(input => input.addEventListener('change', handleDistDataChange));
            thead.querySelectorAll('.editable-header').forEach(th => th.addEventListener('click', () => openDistRecipientModal(th.dataset.recipientId, th.textContent)));
            tbody.querySelectorAll('.editable-header').forEach(td => td.addEventListener('click', () => openDistItemModal(td.dataset.itemId, td.textContent)));
        }

        async function handleDistDataChange(e) {
            const { itemId, recipientId } = e.target.dataset;
            const quantity = e.target.valueAsNumber;
            const docRef = doc(getDistDataRef(), itemId);
            await updateDoc(docRef, { [recipientId]: quantity || 0 });
        }

        // Modals for Distribution Items/Recipients
        const openDistItemModal = (id = null, name = '') => { /* ... modal logic ... */ };
        const openDistRecipientModal = (id = null, name = '') => { /* ... modal logic ... */ };
        // CRUD functions for Distribution Items/Recipients
        const handleDistItemSubmit = async (e) => { /* ... submit logic ... */ };
        const handleDistRecipientSubmit = async (e) => { /* ... submit logic ... */ };
        
        // --- WINDOW.ONLOAD ---
        window.onload = () => {
            // All existing event listeners from previous code are here...
            
            const showScreen = (screenId) => {
                ['main-menu-screen', 'main-app-screen', 'distribution-screen'].forEach(id => document.getElementById(id).classList.add('hidden'));
                document.getElementById(screenId).classList.remove('hidden');
            };

            const showAppScreen = (mode) => {
                currentMode = mode;
                const addButton = document.getElementById('add-transaction-button');
                const controlsContainer = document.getElementById('controls-container');
                
                addButton.classList.remove('w-full', 'bg-orange-500', 'hover:bg-orange-600', 'bg-green-600', 'hover:bg-green-700');
                controlsContainer.classList.remove('flex-wrap');
                
                if (mode === 'purchases') {
                    addButton.classList.add('w-full', 'bg-orange-500', 'hover:bg-orange-600');
                    controlsContainer.classList.add('flex-wrap');
                } else { // sales
                    addButton.classList.add('bg-green-600', 'hover:bg-green-700');
                }
                
                showScreen('main-app-screen');
                startDataListener();
                setLanguage(currentLang);
                showView('clients');
            };

            const showDistributionScreen = () => {
                showScreen('distribution-screen');
                renderDistributionView();
            }

            document.getElementById('goto-sales-btn').addEventListener('click', () => showAppScreen('sales'));
            document.getElementById('goto-purchases-btn').addEventListener('click', () => showAppScreen('purchases'));
            document.getElementById('goto-distribution-btn').addEventListener('click', showDistributionScreen);

            const backToMenu = () => {
                showScreen('main-menu-screen');
                if (unsubscribeDataListener) { unsubscribeDataListener(); unsubscribeDataListener = null; }
            };
            document.getElementById('back-to-menu-btn').addEventListener('click', backToMenu);
            document.getElementById('dist-back-to-menu-btn').addEventListener('click', backToMenu);

            // Rest of window.onload logic remains here...
        };
    </script>

</body>
</html>
