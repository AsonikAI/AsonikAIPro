<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="site-title-tag">–°–∏—Å—Ç–µ–º–∞ –£—á—ë—Ç–∞ –ü—Ä–æ–¥–∞–∂</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à—Ä–∏—Ñ—Ç–∞ Inter –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–∞ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 10px -5px rgba(0, 0, 0, 0.04);
        }
        .min-h-h-screen {
            min-height: calc(100vh - 32px); /* –£—á–∏—Ç—ã–≤–∞–µ–º padding 4 */
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .client-link {
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .client-link.active {
            background-color: #e0f2fe; /* blue-100 */
        }
        @media (min-width: 768px) {
            .client-link.active {
                border-left: 4px solid #3b82f6; /* blue-500 */
                padding-left: calc(1rem - 4px);
                background-color: #e0f2fe;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app-container" class="flex-grow flex flex-col justify-center items-center p-4">

        <!-- 0. –≠–∫—Ä–∞–Ω –ó–∞–≥—Ä—É–∑–∫–∏/–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase -->
        <div id="loading-screen" class="w-full max-w-md bg-white p-10 rounded-xl card flex flex-col items-center justify-center transition-all duration-300">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg font-medium text-gray-700">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã...</p>
        </div>

        <!-- 1. –ì–ª–∞–≤–Ω—ã–π –≠–∫—Ä–∞–Ω –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="main-app-screen" class="hidden w-full max-w-7xl mx-auto flex flex-col min-h-h-screen bg-white rounded-xl card transition-all duration-300 p-6 md:p-8">

            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
            <header class="flex items-center justify-between border-b pb-4 mb-4">
                <h1 class="text-3xl font-bold text-blue-700" id="site-title-display">CYTC.COM SYSTEM</h1>
                <div class="flex items-center space-x-4">
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞ -->
                    <div class="relative group">
                        <button class="flex items-center space-x-1 text-gray-500 hover:text-gray-900 transition duration-150" id="language-button">
                            <span class="text-xl">üá∑üá∫</span> 
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-xl hidden group-hover:block z-10 p-2">
                            <p class="text-sm font-semibold text-gray-700 mb-1">–°–º–µ–Ω–∞ —è–∑—ã–∫–∞ (–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ):</p>
                            <button class="flex items-center space-x-2 w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg" title="–¢–µ–∫—É—â–∏–π —è–∑—ã–∫">
                                <span>üá∑üá∫</span><span>–†—É—Å—Å–∫–∏–π (–¢–µ–∫—É—â–∏–π)</span>
                            </button>
                            <button class="flex items-center space-x-2 w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg">
                                <span>üáπüá∑</span><span>T√ºrk√ße</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
                    <button data-view="clients" class="header-nav-item text-lg font-semibold text-gray-900 border-b-2 border-blue-600 pb-1 px-2 transition duration-150">
                        –û–°–ù–û–í–ê
                    </button>
                    <button data-view="details" id="details-nav-button" class="header-nav-item text-lg font-semibold text-gray-500 hover:text-gray-900 pb-1 px-2 transition duration-150">
                        –ü–û–î–†–û–ë–ù–û
                    </button>
                    <button data-view="settings" class="header-nav-item text-lg font-semibold text-gray-500 hover:text-gray-900 pb-1 px-2 transition duration-150">
                        –ù–ê–°–¢–†–û–ô–ö–ò
                    </button>

                    <button id="logout-button-desktop" class="text-gray-500 hover:text-red-500 transition duration-200" title="–í—ã—Ö–æ–¥">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                </div>
            </header>

            <!-- 1.1 –≠–ö–†–ê–ù: –û–ë–ó–û–† –ö–õ–ò–ï–ù–¢–û–í (–û–°–ù–û–í–ê) -->
            <section id="view-clients" class="view-content flex flex-col flex-grow pt-4 px-4 bg-gray-50 rounded-xl border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">–û–°–ù–û–í–ê (–û–±–∑–æ—Ä –ö–ª–∏–µ–Ω—Ç–æ–≤)</h2>
                
                <!-- –ü–æ–∏—Å–∫ –∏ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
                <div class="flex flex-col gap-3 mb-4">
                    <input type="text" id="client-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <button id="add-transaction-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        –î–æ–±–∞–≤–∏—Ç—å –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—é/–ö–ª–∏–µ–Ω—Ç–∞
                    </button>
                </div>
                
                <!-- –¢–∞–±–ª–∏—Ü–∞ –ö–ª–∏–µ–Ω—Ç–æ–≤: –£—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã–π –º–∞–∫–µ—Ç -->
                <div class="overflow-y-auto flex-grow bg-white rounded-xl border border-gray-100 divide-y divide-gray-100">
                    <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase grid grid-cols-12">
                        <span class="col-span-3">–ö–ª–∏–µ–Ω—Ç / –î–∞—Ç–∞</span>
                        <span class="col-span-3">–¢–æ–≤–∞—Ä (–ö–æ–ª-–≤–æ) / –°—É–º–º–∞</span>
                        <span class="col-span-2 text-center">–ö–∞—Å—Å–∞</span>
                        <span class="col-span-3 text-right">–ü–æ–ª–Ω—ã–π –û—Å—Ç–∞—Ç–æ–∫</span>
                        <span class="col-span-1 text-center">–î–µ–π—Å—Ç–≤.</span>
                    </div>
                    <div id="clients-list-container">
                        <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
                        <div id="no-clients-row" class="p-4 text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö.</div>
                    </div>
                </div>
            </section>

            <!-- 1.2 –≠–ö–†–ê–ù: –î–ï–¢–ê–õ–ò –ö–õ–ò–ï–ù–¢–ê (–ü–û–î–†–û–ë–ù–û) - –¢–µ–ø–µ—Ä—å —ç—Ç–æ —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ -->
            <section id="view-details" class="view-content hidden opacity-0 transition-opacity duration-300 flex-grow flex-col pt-4 px-4 bg-gray-50 rounded-xl border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">–ü–û–î–†–û–ë–ù–û (–í—ã–±–æ—Ä –ö–ª–∏–µ–Ω—Ç–∞)</h2>
                
                <p class="text-gray-600 mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –¥–µ—Ç–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ.</p>
                
                <!-- –ü–æ–∏—Å–∫ –¥–ª—è –ü–û–î–†–û–ë–ù–û -->
                <input type="text" id="details-client-search" placeholder="–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4">

                <!-- –°–ø–∏—Å–æ–∫ –ö–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤ –ü–û–î–†–û–ë–ù–û -->
                <div class="overflow-y-auto flex-grow bg-white rounded-xl border border-gray-100 divide-y divide-gray-100">
                    <div id="details-clients-list-container">
                        <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤, –Ω–æ —Å –∫–Ω–æ–ø–∫–æ–π "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" -->
                        <div class="p-4 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                    </div>
                </div>
            </section>

            <!-- 1.3 –≠–ö–†–ê–ù: –ù–ê–°–¢–†–û–ô–ö–ò -->
            <section id="view-settings" class="view-content hidden opacity-0 transition-opacity duration-300 flex-grow pt-4 px-4">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –°–∏—Å—Ç–µ–º—ã</h1>

                <div class="space-y-8 max-w-2xl">
                    
                    <!-- –°–µ–∫—Ü–∏—è –ù–∞–∑–≤–∞–Ω–∏—è –°–∞–π—Ç–∞ (–ü—É–Ω–∫—Ç 2) -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">–ù–∞–∑–≤–∞–Ω–∏–µ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
                        <label for="app-name-input" class="block text-sm font-medium text-gray-700">–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="app-name-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="CYTC.COM SYSTEM" value="CYTC.COM SYSTEM"/>
                        <p class="text-xs text-gray-500 mt-1">–ù–∞–∑–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∏ –≤–∫–ª–∞–¥–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞.</p>
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–ü—É–Ω–∫—Ç 1) -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)</h3>
                        <p class="text-red-500 mb-4 text-sm">–í –Ω–∞—Å—Ç–æ—è—â–∏–π –º–æ–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã—Ö —É—á–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏. –î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</p>
                        
                        <h4 class="font-semibold text-gray-800 mb-2">–°–º–µ–Ω–∞ –ü–∞—Ä–æ–ª—è (Placeholder)</h4>
                        <div class="space-y-3">
                             <input type="password" placeholder="–°—Ç–∞—Ä—ã–π –ü–∞—Ä–æ–ª—å" disabled class="block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg" />
                             <input type="password" placeholder="–ù–æ–≤—ã–π –ü–∞—Ä–æ–ª—å" disabled class="block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg" />
                             <button disabled class="px-4 py-2 bg-gray-400 text-white font-semibold rounded-lg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ü–∞—Ä–æ–ª—å</button>
                        </div>
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è –£—á—ë—Ç–Ω–æ–π –ó–∞–ø–∏—Å–∏ -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">–í–∞—à–∞ –£—á—ë—Ç–Ω–∞—è –ó–∞–ø–∏—Å—å</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">–°—Ç–∞—Ç—É—Å</label>
                                <input type="text" value="–ê–Ω–æ–Ω–∏–º–Ω—ã–π/–¢–æ–∫–µ–Ω–æ–≤—ã–π –í—Ö–æ–¥" disabled class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                                <code id="user-id-display-settings" class="block bg-gray-100 p-2 rounded text-sm text-gray-700 break-all">...</code>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <!-- 2. –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –¢–†–ê–ù–ó–ê–ö–¶–ò–ô (–î–û–ë–ê–í–õ–ï–ù–ò–ï/–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï) -->
    <div id="transaction-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-lg p-6 rounded-xl card transform transition-all duration-300 scale-95 opacity-0" id="transaction-modal-content">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-900 mb-4">–î–æ–±–∞–≤–∏—Ç—å –ù–æ–≤—É—é –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h2>
            <form id="transaction-form" class="space-y-4">
                <input type="hidden" id="transaction-doc-id">
                <input type="hidden" id="transaction-client-id">
                
                <!-- –ò–º—è –ö–ª–∏–µ–Ω—Ç–∞ -->
                <div>
                    <label for="modal-client-name" class="block text-sm font-medium text-gray-700">–ò–º—è –ö–ª–∏–µ–Ω—Ç–∞ (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="text" id="modal-client-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- –¢–æ–≤–∞—Ä / –û–ø–∏—Å–∞–Ω–∏–µ -->
                <div>
                    <label for="modal-item-name" class="block text-sm font-medium text-gray-700">–¢–æ–≤–∞—Ä / –û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <input type="text" id="modal-item-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="–¢–æ–≤–∞—Ä">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É -->
                    <div>
                        <label for="modal-unit-price" class="block text-sm font-medium text-gray-700">–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É ($)</label>
                        <input type="number" step="0.01" id="modal-unit-price" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="100">
                    </div>
                    <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
                    <div>
                        <label for="modal-quantity" class="block text-sm font-medium text-gray-700">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç)</label>
                        <input type="number" step="1" id="modal-quantity" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="1">
                    </div>
                </div>

                <!-- –í–Ω–µ—Å–µ–Ω–æ (–ö–∞—Å—Å–∞) -->
                <div>
                    <label for="modal-payment-received" class="block text-sm font-medium text-gray-700">–í–Ω–µ—Å–µ–Ω–æ (–ö–∞—Å—Å–∞, $)</label>
                    <input type="number" step="0.01" id="modal-payment-received" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="100">
                    <p class="text-xs text-gray-500 mt-1">–û—Å—Ç–∞—Ç–æ–∫ –±—É–¥–µ—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–°—É–º–º–∞ - –í–Ω–µ—Å–µ–Ω–æ).</p>
                </div>
                
                <!-- –î–∞—Ç–∞ -->
                <div>
                    <label for="modal-transaction-date" class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</label>
                    <input type="date" id="modal-transaction-date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="flex justify-between pt-4">
                    <button type="button" id="modal-close-button" class="px-5 py-2.5 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 3. –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –î–ï–¢–ê–õ–ï–ô (–ü–û–î–†–û–ë–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–õ–ò–ï–ù–¢–ï) -->
    <div id="details-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-4xl max-h-[90vh] overflow-y-auto p-8 rounded-xl card transform transition-all duration-300 scale-95 opacity-0" id="details-modal-content">
            <div class="flex justify-between items-start mb-6 border-b pb-3">
                <h2 class="text-3xl font-bold text-gray-900" id="modal-details-client-name"></h2>
                <button id="modal-details-close-button" class="text-gray-500 hover:text-gray-900">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- –°–≤–æ–¥–∫–∞ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <p class="text-sm font-medium text-blue-800">–í—Å–µ–≥–æ –ü—Ä–æ–¥–∞–Ω–æ</p>
                    <p class="text-2xl font-bold text-blue-900 mt-1" id="modal-details-total-sales">$0.00</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <p class="text-sm font-medium text-green-800">–í–Ω–µ—Å–µ–Ω–æ (–ö–∞—Å—Å–∞)</p>
                    <p class="text-2xl font-bold text-green-900 mt-1" id="modal-details-total-paid">$0.00</p>
                </div>
                <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                    <p class="text-sm font-medium text-red-800">–ü–æ–ª–Ω—ã–π –û—Å—Ç–∞—Ç–æ–∫</p>
                    <p class="text-2xl font-bold text-red-900 mt-1" id="modal-details-remaining">$0.00</p>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="flex space-x-3 mb-6">
                 <button id="modal-add-transaction-button" class="flex-grow flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2 px-4 rounded-lg transition duration-200">
                    + –î–æ–±–∞–≤–∏—Ç—å –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                </button>
                <button id="modal-delete-client-button" class="flex-grow flex items-center justify-center bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-2 px-4 rounded-lg transition duration-200">
                    –£–¥–∞–ª–∏—Ç—å –ö–ª–∏–µ–Ω—Ç–∞
                </button>
            </div>

            <h3 class="text-xl font-semibold text-gray-800 mb-3">–ò—Å—Ç–æ—Ä–∏—è –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h3>
            
             <!-- –ü–æ–∏—Å–∫ –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º –≤ –º–æ–¥–∞–ª–µ -->
            <input type="text" id="modal-transaction-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä—É –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4 w-full">

            <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π -->
            <div class="bg-white rounded-lg border border-gray-100 overflow-x-auto">
                 <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="bg-gray-50 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            <th class="px-4 py-3 text-left">–î–∞—Ç–∞</th>
                            <th class="px-4 py-3 text-left">–¢–æ–≤–∞—Ä (–ö–æ–ª-–≤–æ)</th>
                            <th class="px-4 py-3 text-right">–°—É–º–º–∞</th>
                            <th class="px-4 py-3 text-right">–í–Ω–µ—Å–µ–Ω–æ</th>
                            <th class="px-4 py-3 text-right">–û—Å—Ç–∞—Ç–æ–∫</th>
                            <th class="px-4 py-3 text-center">–î–µ–π—Å—Ç–≤.</th>
                        </tr>
                    </thead>
                    <tbody id="modal-transactions-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="px-4 py-3 text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, where, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, getDocs, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï FIREBASE (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) ===
        
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∑–∞–ø–∞—Å–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
        const CUSTOM_FIREBASE_CONFIG = {
            apiKey: "AIzaSyB1FLSf6PBzNzb7_CWYH6Y0_--jhqO9MLQ",
            authDomain: "asonik-ai.firebaseapp.com",
            projectId: "asonik-ai",
            storageBucket: "asonik-ai.firebasestorage.app",
            messagingSenderId: "875716508614",
            appId: "1:875716508614:web:ad264fdd60a20eb7dd90c7",
            measurementId: "G-HT5T20YPVE"
        };
        
        // App ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Firebase Config: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–¥–∞–µ—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ —Å—Ä–µ–¥—ã Canvas, –µ—Å–ª–∏ –æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞.
        let firebaseConfig = null;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ —Å—Ä–µ–¥—ã
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Failed to parse __firebase_config:", e);
            }
        }
        
        // –ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ —Å—Ä–µ–¥—ã –Ω–µ –±—ã–ª–∞ –ø–æ–ª—É—á–µ–Ω–∞ –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é.
        if (!firebaseConfig || !firebaseConfig.apiKey) {
            firebaseConfig = CUSTOM_FIREBASE_CONFIG;
        }

        // Auth Token
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let currentUserId = null;
        let currentClientDetailsId = null; // ID –∫–ª–∏–µ–Ω—Ç–∞, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–µ—Ç–∞–ª–∏
        let currentTransactionFilter = ''; // –§–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∫–ª–∏–µ–Ω—Ç–∞
        let modalTransactionFilter = ''; // –§–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ

        // –ö—ç—à –¥–ª—è –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö
        let clientAggregates = {};
        let allTransactions = [];

        // === –£–¢–ò–õ–ò–¢–´ ===

        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ –≤ –≤–∞–ª—é—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ($XX.XX).
         * @param {number} amount
         * @returns {string}
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }

        /**
         * –ü–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—é –∑–∞–ø–∏—Å–µ–π –æ –ø—Ä–æ–¥–∞–∂–∞—Ö.
         * @returns {import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js").CollectionReference}
         */
        function getSalesCollectionRef() {
            if (!db || !currentUserId) return null;
            // –ü—É—Ç—å –¥–ª—è —á–∞—Å—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: /artifacts/{appId}/users/{userId}/sales_records
            return collection(db, 'artifacts', appId, 'users', currentUserId, 'sales_records');
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π (–≥–ª–∞–≤–Ω—ã–π –º–∞–∫–µ—Ç –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏).
         * @param {string} viewId - ID –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ (clients, details, settings).
         */
        function showView(viewId) {
            document.querySelectorAll('.view-content').forEach(view => {
                const targetId = `view-${viewId}`;
                if (view.id === targetId) {
                    view.classList.remove('hidden', 'opacity-0');
                    view.classList.add('opacity-100');
                } else {
                    view.classList.add('hidden', 'opacity-0');
                    view.classList.remove('opacity-100');
                }
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –º–µ–Ω—é –∑–∞–≥–æ–ª–æ–≤–∫–∞
            document.querySelectorAll('.header-nav-item').forEach(item => {
                item.classList.remove('border-blue-600', 'text-gray-900');
                item.classList.add('border-transparent', 'text-gray-500');

                if (item.getAttribute('data-view') === viewId) {
                    item.classList.add('border-blue-600', 'text-gray-900');
                    item.classList.remove('border-transparent', 'text-gray-500');
                }
            });
            
            // –õ–æ–≥–∏–∫–∞ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –ü–û–î–†–û–ë–ù–û
            if (viewId === 'details') {
                // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ü–û–î–†–û–ë–ù–û"
                renderDetailsClientList(clientAggregates, document.getElementById('details-client-search').value);
            }
        }

        // === –õ–û–ì–ò–ö–ê FIREBASE –ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
         */
        function setupFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Firebase config is missing or invalid after fallback.");
                document.getElementById('loading-screen').innerHTML = '<p class="text-red-600">–û—à–∏–±–∫–∞: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Firebase.</p>';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        
                        const userIdDisplaySettings = document.getElementById('user-id-display-settings');
                        if (userIdDisplaySettings) { 
                             userIdDisplaySettings.textContent = currentUserId;
                        }

                        document.getElementById('loading-screen').classList.add('hidden');
                        document.getElementById('main-app-screen').classList.remove('hidden');

                        // –ó–∞–ø—É—Å–∫ –≥–ª–∞–≤–Ω–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è –¥–∞–Ω–Ω—ã—Ö
                        startDataListener();

                        // –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω—ã–π –º–∞–∫–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        showView('clients');

                    } else {
                        // –ü–æ–ø—ã—Ç–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loading-screen').innerHTML = `<p class="text-red-600">–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}</p>`;
            }
        }

        // === –õ–û–ì–ò–ö–ê –î–ê–ù–ù–´–• (CRUD –∏ –ê–ì–†–ï–ì–ê–¶–ò–Ø) ===

        /**
         * –ì–ª–∞–≤–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –¥–∞–Ω–Ω—ã—Ö Firestore. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
         * –∏ –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∏—Ö –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤.
         */
        function startDataListener() {
            const salesRef = getSalesCollectionRef();
            if (!salesRef) return;

            onSnapshot(salesRef, (snapshot) => {
                allTransactions = [];
                clientAggregates = {};
                
                let totalSalesGlobal = 0;
                let totalPaidGlobal = 0;
                
                const latestTransactionMap = {};
                
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const transaction = {
                        ...data,
                        id: doc.id,
                        transactionDate: data.transactionDate ? data.transactionDate.toDate().toISOString().split('T')[0] : 'N/A', 
                        totalAmount: data.quantity * data.unitPrice
                    };
                    allTransactions.push(transaction);

                    // –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –∫–ª–∏–µ–Ω—Ç—É
                    if (!clientAggregates[transaction.clientId]) {
                        clientAggregates[transaction.clientId] = {
                            name: transaction.clientName,
                            totalSales: 0,
                            totalPaid: 0,
                            transactionCount: 0,
                            totalQuantity: 0,
                            lastTransactionDate: data.transactionDate ? data.transactionDate.toDate() : null
                        };
                    }

                    const agg = clientAggregates[transaction.clientId];
                    agg.totalSales += transaction.totalAmount;
                    agg.totalPaid += transaction.paymentReceived;
                    agg.transactionCount++;
                    agg.totalQuantity += transaction.quantity;
                    
                    const currentTransDate = data.transactionDate.toDate();
                    if (!agg.lastTransactionDate || currentTransDate > agg.lastTransactionDate) {
                        agg.lastTransactionDate = currentTransDate;
                        latestTransactionMap[transaction.clientId] = transaction;
                    }
                    
                    totalSalesGlobal += transaction.totalAmount;
                    totalPaidGlobal += transaction.paymentReceived;
                });
                
                Object.keys(clientAggregates).forEach(clientId => {
                    clientAggregates[clientId].lastTransaction = latestTransactionMap[clientId];
                });

                
                renderClientsList(clientAggregates, document.getElementById('client-search').value);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –ü–û–î–†–û–ë–ù–û (–µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞)
                const currentView = document.querySelector('.header-nav-item.border-blue-600').getAttribute('data-view');
                if (currentView === 'details') {
                    renderDetailsClientList(clientAggregates, document.getElementById('details-client-search').value);
                }
                
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –¥–µ—Ç–∞–ª–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                if (currentClientDetailsId) {
                    updateClientDetailsModalKPI();
                    filterAndRenderModalTransactions();
                }

            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö Firestore:", error);
            });
        }

        /**
         * –†–µ–Ω–¥–µ—Ä–∏—Ç —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –û–°–ù–û–í–ê.
         */
        function renderClientsList(aggregates, filter = '') {
            const container = document.getElementById('clients-list-container');
            container.innerHTML = '';
            
            const clientIds = Object.keys(aggregates);
            if (clientIds.length === 0) {
                 container.innerHTML = '<div id="no-clients-row" class="p-4 text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö.</div>';
                 return;
            }
            
            const lowerCaseFilter = filter.toLowerCase();

            const sortedClients = clientIds.map(id => ({ id, ...aggregates[id] }))
                                            .sort((a, b) => b.lastTransactionDate - a.lastTransactionDate);

            sortedClients.forEach(client => {
                if (filter && !client.name.toLowerCase().includes(lowerCaseFilter)) {
                    return; 
                }

                const remaining = client.totalSales - client.totalPaid;
                const lastTrans = client.lastTransaction || {};
                const lastDate = lastTrans.transactionDate || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                
                const clientCard = document.createElement('div');
                clientCard.className = `client-link grid grid-cols-12 items-center p-4 hover:bg-gray-100 ${client.id === currentClientDetailsId ? 'active' : ''}`;
                clientCard.setAttribute('data-client-id', client.id);
                
                clientCard.onclick = () => {
                    // –ö–ª–∏–∫ —Ç–æ–ª—å–∫–æ –≤—ã–±–∏—Ä–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç –µ–≥–æ
                    currentClientDetailsId = client.id;
                    document.querySelectorAll('.client-link').forEach(link => link.classList.remove('active'));
                    clientCard.classList.add('active');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ–Ω–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –ü–û–î–†–û–ë–ù–û
                    updateClientDetailsModalKPI();
                    filterAndRenderModalTransactions();
                };
                
                // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è inline JS
                const escapedClientName = client.name.replace(/'/g, "\\'");
                const escapedItemName = (lastTrans.itemName || '').replace(/'/g, "\\'");

                clientCard.innerHTML = `
                    <div class="col-span-3 flex flex-col">
                        <span class="text-base font-semibold text-gray-900">${client.name}</span>
                        <span class="text-xs text-gray-500 mt-0.5">${lastDate}</span>
                    </div>
                    <div class="col-span-3 flex flex-col">
                        <span class="text-sm font-medium text-gray-800 truncate">${lastTrans.itemName || 'N/A'} (x${lastTrans.quantity || 0})</span>
                        <span class="text-xs text-blue-600">–°—É–º–º–∞: ${formatCurrency(lastTrans.totalAmount || 0)}</span>
                    </div>
                    <div class="col-span-2 text-center flex flex-col text-sm font-medium">
                        <span class="text-green-600">${formatCurrency(client.totalPaid || 0)}</span>
                        <span class="text-xs text-gray-500">–ö–∞—Å—Å–∞</span>
                    </div>
                    <div class="col-span-3 text-right flex flex-col items-end">
                        <span class="text-lg font-bold ${remaining > 0 ? 'text-red-600' : 'text-green-600'}">
                            ${formatCurrency(remaining)}
                        </span>
                        <span class="block text-xs text-gray-400">–û—Å—Ç–∞—Ç–æ–∫ (${client.transactionCount} —Ç—Ä.)</span>
                    </div>
                    <div class="col-span-1 text-center">
                        <button class="text-blue-600 hover:text-blue-900 text-sm" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é" onclick="event.stopPropagation(); openTransactionModal(
                            '${lastTrans.id || ''}', 
                            '${client.id}', 
                            '${escapedClientName}', 
                            '${escapedItemName}', 
                            ${lastTrans.unitPrice || 0}, 
                            ${lastTrans.quantity || 0}, 
                            ${lastTrans.paymentReceived || 0}, 
                            '${lastDate}'
                        )">
                            –†–µ–¥.
                        </button>
                    </div>
                `;
                container.appendChild(clientCard);
            });
        }
        
        /**
         * –†–µ–Ω–¥–µ—Ä–∏—Ç —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –ü–û–î–†–û–ë–ù–û (–≤—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞).
         */
        function renderDetailsClientList(aggregates, filter = '') {
             const container = document.getElementById('details-clients-list-container');
             container.innerHTML = '';
            
             const clientIds = Object.keys(aggregates);
             if (clientIds.length === 0) {
                 container.innerHTML = '<div class="p-4 text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö.</div>';
                 return;
             }
            
             const lowerCaseFilter = filter.toLowerCase();

             const sortedClients = clientIds.map(id => ({ id, ...aggregates[id] }))
                                             .sort((a, b) => b.lastTransactionDate - a.lastTransactionDate);

             sortedClients.forEach(client => {
                 if (filter && !client.name.toLowerCase().includes(lowerCaseFilter)) {
                     return; 
                 }
                 
                 const remaining = client.totalSales - client.totalPaid;
                 const clientCard = document.createElement('div');
                 clientCard.className = `client-link flex justify-between items-center p-4 hover:bg-gray-100 rounded-lg ${client.id === currentClientDetailsId ? 'active' : ''}`;
                 
                 clientCard.innerHTML = `
                     <div class="flex flex-col">
                         <span class="text-base font-semibold text-gray-900">${client.name}</span>
                         <span class="text-xs text-gray-500">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${client.transactionCount} | –û—Å—Ç–∞—Ç–æ–∫: ${formatCurrency(remaining)}</span>
                     </div>
                     <button class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded-lg transition duration-200" onclick="openClientDetailsModal('${client.id}')">
                         –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                     </button>
                 `;
                 container.appendChild(clientCard);
             });
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∏–Ω–ª–∞–π–Ω-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
        window.openTransactionModal = openTransactionModal;
        window.deleteTransaction = deleteTransaction;
        window.showClientDetails = showClientDetails; // –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –º–µ–Ω—è–µ—Ç –≤–∫–ª–∞–¥–∫—É
        window.openClientDetailsModal = openClientDetailsModal; // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ—Ç–∞–ª–µ–π

        /**
         * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
         * @param {string} clientId
         */
        function openClientDetailsModal(clientId) {
            currentClientDetailsId = clientId;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤ —Å–ø–∏—Å–∫–µ "–ü–û–î–†–û–ë–ù–û"
            document.querySelectorAll('#details-clients-list-container .client-link').forEach(link => {
                link.classList.remove('active');
            });
            const selectedLink = document.querySelector(`#details-clients-list-container [data-client-id="${clientId}"]`);
            if (selectedLink) selectedLink.classList.add('active');

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            updateClientDetailsModalKPI();
            filterAndRenderModalTransactions();
            
            const modal = document.getElementById('details-modal');
            const modalContent = document.getElementById('details-modal-content');
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤–æ–¥–Ω—ã–µ KPI –∫–ª–∏–µ–Ω—Ç–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –¥–µ—Ç–∞–ª–µ–π.
         */
        function updateClientDetailsModalKPI() {
            if (!currentClientDetailsId) return;

            const clientAgg = clientAggregates[currentClientDetailsId];
            if (!clientAgg) return;
            
            const remaining = clientAgg.totalSales - clientAgg.totalPaid;
            
            document.getElementById('modal-details-client-name').textContent = clientAgg.name;
            document.getElementById('modal-details-total-sales').textContent = formatCurrency(clientAgg.totalSales);
            document.getElementById('modal-details-total-paid').textContent = formatCurrency(clientAgg.totalPaid);
            document.getElementById('modal-details-remaining').textContent = formatCurrency(remaining);
            document.getElementById('modal-details-remaining').classList.toggle('text-red-900', remaining > 0);
            document.getElementById('modal-details-remaining').classList.toggle('text-green-900', remaining <= 0);
        }
        
        /**
         * –†–µ–Ω–¥–µ—Ä–∏—Ç —Ç–∞–±–ª–∏—Ü—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ, –ø—Ä–∏–º–µ–Ω—è—è —Ñ–∏–ª—å—Ç—Ä.
         */
        function filterAndRenderModalTransactions() {
            if (!currentClientDetailsId) return;

            const filter = modalTransactionFilter.toLowerCase();

            let clientTransactions = allTransactions
                .filter(t => t.clientId === currentClientDetailsId)
                .sort((a, b) => new Date(b.transactionDate) - new Date(a.transactionDate)); 

            if (filter) {
                clientTransactions = clientTransactions.filter(t => 
                    t.itemName.toLowerCase().includes(filter) || t.transactionDate.includes(filter)
                );
            }
            
            const tbody = document.getElementById('modal-transactions-table-body');
            tbody.innerHTML = '';

            if (clientTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-3 text-center text-gray-500">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä—É.</td></tr>';
                return;
            }

            clientTransactions.forEach(t => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50';

                const remainingInTransaction = t.totalAmount - t.paymentReceived;
                
                const escapedClientName = t.clientName.replace(/'/g, "\\'");
                const escapedItemName = t.itemName.replace(/'/g, "\\'");
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${t.transactionDate}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${t.itemName} (x${t.quantity})</td>
                    <td class="px-4 py-3 text-right text-sm font-medium text-blue-600">${formatCurrency(t.totalAmount)}</td>
                    <td class="px-4 py-3 text-right text-sm font-medium text-green-600">${formatCurrency(t.paymentReceived)}</td>
                    <td class="px-4 py-3 text-right text-sm font-bold ${remainingInTransaction > 0 ? 'text-red-600' : 'text-gray-600'}">${formatCurrency(remainingInTransaction)}</td>
                    <td class="px-4 py-3 text-center whitespace-nowrap">
                        <button class="text-blue-600 hover:text-blue-900 mr-2 text-sm" onclick="closeClientDetailsModal(); openTransactionModal(
                            '${t.id}', 
                            '${t.clientId}', 
                            '${escapedClientName}', 
                            '${escapedItemName}', 
                            ${t.unitPrice}, 
                            ${t.quantity}, 
                            ${t.paymentReceived}, 
                            '${t.transactionDate}'
                        )">
                            –†–µ–¥.
                        </button>
                    </td>
                `;
            });
        }


        /**
         * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
         */
        function openTransactionModal(docId = null, clientId = null, clientName = '', itemName = '–¢–æ–≤–∞—Ä', unitPrice = 100, quantity = 1, paymentReceived = 0, transactionDate = new Date().toISOString().split('T')[0]) {
            const modal = document.getElementById('transaction-modal');
            const modalContent = document.getElementById('transaction-modal-content');
            
            document.getElementById('modal-title').textContent = docId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—é' : '–î–æ–±–∞–≤–∏—Ç—å –ù–æ–≤—É—é –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—é';
            document.getElementById('transaction-doc-id').value = docId || '';
            
            // === –õ–û–ì–ò–ö–ê ID –ö–õ–ò–ï–ù–¢–ê ===
            let finalClientId = clientId;
            const isAddingNewFromClientsList = !docId && !currentClientDetailsId;
            
            if (isAddingNewFromClientsList) {
                finalClientId = crypto.randomUUID();
            } else if (!docId && currentClientDetailsId) {
                finalClientId = currentClientDetailsId;
            } else if (docId && !clientId) {
                 // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–π –¥–æ–∫, –Ω–æ –ø–æ—á–µ–º—É-—Ç–æ –ø–æ—Ç–µ—Ä—è–ª–∏ clientId, 
                 // –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –µ–≥–æ —á–µ—Ä–µ–∑ allTransactions (–∑–∞—â–∏—Ç–∞)
                 const oldTrans = allTransactions.find(t => t.id === docId);
                 finalClientId = oldTrans ? oldTrans.clientId : crypto.randomUUID();
            } else if (!finalClientId) {
                 finalClientId = crypto.randomUUID(); // –ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞—â–∏—Ç–∞
            }
            
            document.getElementById('transaction-client-id').value = finalClientId; 
            document.getElementById('modal-client-name').value = clientName;
            
            
            // === –õ–û–ì–ò–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò –ò–ú–ï–ù–ò ===
            const modalClientNameInput = document.getElementById('modal-client-name');
            
            if (docId || currentClientDetailsId) {
                 // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∫–ª–∏–µ–Ω—Ç—É -> –∏–º—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
                 modalClientNameInput.disabled = true; 
                 
                 // –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É, —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–¥—Ç—è–Ω—É—Ç–æ
                 if (!docId && currentClientDetailsId) {
                     const clientAgg = clientAggregates[currentClientDetailsId];
                     if (clientAgg) {
                        modalClientNameInput.value = clientAgg.name;
                     }
                 }
                 
            } else {
                 // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏/–∫–ª–∏–µ–Ω—Ç–∞ -> –∏–º—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
                 modalClientNameInput.disabled = false;
                 modalClientNameInput.value = ''; 
            }


            document.getElementById('modal-item-name').value = itemName;
            document.getElementById('modal-unit-price').value = unitPrice;
            document.getElementById('modal-quantity').value = quantity;
            document.getElementById('modal-payment-received').value = paymentReceived;
            document.getElementById('modal-transaction-date').value = transactionDate;

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        /**
         * –°–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ.
         */
        function closeTransactionModal() {
            const modal = document.getElementById('transaction-modal');
            const modalContent = document.getElementById('transaction-modal-content');

            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                // –ï—Å–ª–∏ –º—ã –∑–∞–∫—Ä—ã–ª–∏ –º–æ–¥–∞–ª, –∏ –∞–∫—Ç–∏–≤–µ–Ω —ç–∫—Ä–∞–Ω –¥–µ—Ç–∞–ª–µ–π, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                if (document.getElementById('details-modal').classList.contains('hidden') === false) {
                     updateClientDetailsModalKPI();
                     filterAndRenderModalTransactions();
                }
            }, 300);
        }
        
        /**
         * –°–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π.
         */
        function closeClientDetailsModal() {
            const modal = document.getElementById('details-modal');
            const modalContent = document.getElementById('details-modal-content');

            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }


        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ).
         */
        async function handleTransactionSubmit(event) {
            event.preventDefault();

            const docId = document.getElementById('transaction-doc-id').value;
            const clientId = document.getElementById('transaction-client-id').value;
            const clientName = document.getElementById('modal-client-name').value.trim();
            // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è)
            const itemName = document.getElementById('modal-item-name').value.trim();
            const unitPrice = parseFloat(document.getElementById('modal-unit-price').value);
            const quantity = parseInt(document.getElementById('modal-quantity').value);
            const paymentReceived = parseFloat(document.getElementById('modal-payment-received').value);
            const transactionDate = document.getElementById('modal-transaction-date').value;
            
            if (!clientName || !itemName || isNaN(unitPrice) || isNaN(quantity) || isNaN(paymentReceived) || !transactionDate) {
                console.error("–ù–µ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.");
                return;
            }

            const data = {
                clientId: clientId,
                clientName: clientName,
                itemName: itemName,
                unitPrice: unitPrice,
                quantity: quantity,
                paymentReceived: paymentReceived,
                totalAmount: unitPrice * quantity,
                transactionDate: new Date(transactionDate)
            };

            const salesRef = getSalesCollectionRef();
            if (!salesRef) return;

            const savedClientId = clientId; 

            try {
                if (docId) {
                    await updateDoc(doc(salesRef, docId), data);
                } else {
                    await addDoc(salesRef, data);
                }

                closeTransactionModal();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                currentClientDetailsId = savedClientId; 
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
                document.querySelectorAll('.client-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('data-client-id') === savedClientId) {
                        link.classList.add('active');
                    }
                });

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:", error);
            }
        }

        /**
         * –£–¥–∞–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.
         * @param {string} docId - ID –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.
         */
        async function deleteTransaction(docId) {
            const salesRef = getSalesCollectionRef();
            if (!salesRef) return;

            const isConfirmed = window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?'); 

            if (isConfirmed) {
                try {
                    await deleteDoc(doc(salesRef, docId));
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:", error);
                }
            }
        }
        
        /**
         * –£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω.
         * @param {string} clientId - ID –∫–ª–∏–µ–Ω—Ç–∞.
         */
        async function deleteClientAndTransactions(clientId) {
            const clientAgg = clientAggregates[clientId];
            if (!clientAgg) {
                console.warn(`–ö–ª–∏–µ–Ω—Ç —Å ID ${clientId} –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
                return;
            }
            
            const isConfirmed = window.confirm(`–í–ù–ò–ú–ê–ù–ò–ï! –í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ "${clientAgg.name}" –∏ –í–°–ï –µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`);

            if (isConfirmed) {
                const salesRef = getSalesCollectionRef();
                if (!salesRef) return;

                try {
                    const clientQuery = query(salesRef, where("clientId", "==", clientId));
                    const snapshot = await getDocs(clientQuery);

                    const batch = writeBatch(db);
                    
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();

                    // 4. –°–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                    currentClientDetailsId = null;
                    closeClientDetailsModal(); 
                    showView('clients'); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω –û–±–∑–æ—Ä–∞
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:", error);
                    window.alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
                }
            }
        }


        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ===

        window.onload = function() {
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
            document.getElementById('add-transaction-button').addEventListener('click', () => {
                openTransactionModal();
            });
            
            document.getElementById('modal-close-button').addEventListener('click', closeTransactionModal);
            document.getElementById('transaction-form').addEventListener('submit', handleTransactionSubmit);
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ—Ç–∞–ª–µ–π
            document.getElementById('modal-details-close-button').addEventListener('click', closeClientDetailsModal);
            document.getElementById('modal-add-transaction-button').addEventListener('click', () => {
                 closeClientDetailsModal(); 
                 const clientAgg = clientAggregates[currentClientDetailsId];
                 if (clientAgg) {
                    openTransactionModal(null, currentClientDetailsId, clientAgg.name);
                 }
            });
            document.getElementById('modal-delete-client-button').addEventListener('click', () => {
                 if (currentClientDetailsId) {
                    deleteClientAndTransactions(currentClientDetailsId);
                 }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
            document.querySelectorAll('.header-nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    showView(e.currentTarget.getAttribute('data-view'));
                });
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞
            document.getElementById('logout-button-desktop').addEventListener('click', () => signOut(auth).catch(e => console.error("Logout failed:", e)));
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∞–π—Ç–∞
            document.getElementById('app-name-input').addEventListener('input', (e) => {
                const newTitle = e.target.value.trim() || "–°–∏—Å—Ç–µ–º–∞ –£—á—ë—Ç–∞ –ü—Ä–æ–¥–∞–∂";
                document.getElementById('site-title-display').textContent = newTitle;
                document.getElementById('site-title-tag').textContent = newTitle;
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–û–°–ù–û–í–ê)
            document.getElementById('client-search').addEventListener('input', (e) => {
                renderClientsList(clientAggregates, e.target.value);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ü–û–î–†–û–ë–ù–û)
            document.getElementById('details-client-search').addEventListener('input', (e) => {
                 renderDetailsClientList(clientAggregates, e.target.value);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            document.getElementById('modal-transaction-search').addEventListener('input', (e) => {
                modalTransactionFilter = e.target.value;
                filterAndRenderModalTransactions();
            });
            

            // –£—Å—Ç–∞–Ω–æ–≤–∏–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–µ
            document.getElementById('modal-transaction-date').value = new Date().toISOString().split('T')[0];

            // –ù–∞—á–∞—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Firebase
            setupFirebase();
        };

    </script>
</body>
</html>
