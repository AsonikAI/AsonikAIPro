<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ya_Buxgalter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            background-color: var(--bg-color);
            transition: color 0.3s, background-color 0.3s;
        }
        :root {
            --primary-color: #b91c1c; /* red-700 */
            --secondary-color: #ef4444; /* red-500 */
            --bg-color: #f3f4f6; /* gray-100 */
            --text-color: #1f2937; /* gray-800 */
            --card-bg-color: #ffffff; /* white */
        }
        body.dark-theme {
            --primary-color: #990000; /* dark red */
            --secondary-color: #ff3333; /* lighter dark red */
            --bg-color: #121212; /* dark black */
            --text-color: #e0e0e0; /* light gray */
            --card-bg-color: #1e1e1e; /* dark gray */
        }
        .text-ya_buxgalter {
            color: var(--primary-color);
        }
        .bg-ya_buxgalter {
            background-color: var(--primary-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        .btn-logout {
            background-color: #ef4444; /* bright red */
            color: white;
        }
        .btn-logout:hover {
            background-color: #b91c1c; /* dark red */
        }
        /* Admin Panel specific styles */
        .admin-panel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .admin-panel-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <nav class="bg-white shadow p-4 flex justify-between items-center fixed top-0 w-full z-50">
        <div class="flex items-center space-x-4">
            <a href="#" id="logo-link" class="flex items-center space-x-2">
                <img id="logo-image" src="" alt="Логотип" class="h-8 w-8">
                <span id="logo-text" class="text-2xl font-bold text-ya_buxgalter"></span>
            </a>
        </div>
        <div class="flex items-center space-x-4">
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200">
                <svg id="moon-icon" class="w-6 h-6 text-gray-800 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
                <svg id="sun-icon" class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
            </button>
            <div id="user-info" class="flex items-center space-x-2 hidden">
                <img id="user-avatar" src="https://via.placeholder.com/40" alt="Аватар" class="w-10 h-10 rounded-full object-cover">
                <div class="flex flex-col">
                    <span id="user-name" class="font-medium"></span>
                    <span id="user-role" class="text-sm text-gray-500"></span>
                </div>
                <button id="logout-btn" class="btn-logout text-white px-3 py-1 rounded-md text-sm font-semibold transition-colors duration-200">Выход</button>
            </div>
            <div id="guest-info" class="space-x-4">
                <button id="login-btn-nav" class="btn-primary text-white px-4 py-2 rounded-md font-semibold transition-colors duration-200">Вход</button>
                <button id="contact-btn-nav" class="btn-primary text-white px-4 py-2 rounded-md font-semibold transition-colors duration-200">Связаться</button>
            </div>
        </div>
    </nav>

    <main class="mt-20 p-4">
        <section id="main-page-section" class="flex flex-col items-center justify-center text-center p-8">
            <h1 class="text-4xl md:text-6xl font-extrabold text-ya_buxgalter mb-4">Ya_Buxgalter</h1>
            <p class="text-lg md:text-xl text-gray-600 mb-8">Платформа для курсов по бухгалтерии. Обучение, которое меняет жизнь!</p>
            <button id="enroll-now-btn" class="bg-ya_buxgalter text-white px-8 py-4 rounded-md text-xl font-semibold hover:bg-red-500 transition-colors duration-200">Записаться на курс</button>

            <div class="container mx-auto mt-16">
                <h2 class="text-3xl font-bold text-center mb-8">Наши преимущества</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="font-bold text-xl mb-2 text-ya_buxgalter">Удобно</h3>
                        <p class="text-gray-600">Обучайтесь онлайн в удобное для вас время, из любой точки мира.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="font-bold text-xl mb-2 text-ya_buxgalter">Доступно</h3>
                        <p class="text-gray-600">Эффективные курсы по доступной цене. Мы делаем образование доступным.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="font-bold text-xl mb-2 text-ya_buxgalter">Уникально</h3>
                        <p class="text-gray-600">Единственный в Узбекистане онлайн-курс по бухгалтерии с живыми вебинарами.</p>
                    </div>
                </div>
            </div>

            <div class="container mx-auto mt-16">
                <h2 class="text-3xl font-bold text-center mb-8">Наши курсы</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="font-bold text-xl mb-2 text-ya_buxgalter">Индивидуальный</h3>
                        <p class="text-gray-600">Персональное обучение с наставником. Индивидуальный подход к каждому.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="font-bold text-xl mb-2 text-ya_buxgalter">Группа</h3>
                        <p class="text-gray-600">Обучение в небольшой группе. Возможность общения и обмена опытом.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="font-bold text-xl mb-2 text-ya_buxgalter">Онлайн</h3>
                        <p class="text-gray-600">Полностью онлайн-формат с доступом к записям уроков и материалам.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="login-section" class="hidden flex flex-col items-center justify-center p-8">
            <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
                <h2 class="text-2xl font-bold text-center mb-6">Вход в систему</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-gray-700 font-bold mb-2">Email</label>
                        <input type="email" id="login-email" name="email" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-ya_buxgalter" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-gray-700 font-bold mb-2">Пароль</label>
                        <input type="password" id="login-password" name="password" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-ya_buxgalter" required>
                    </div>
                    <button type="submit" class="w-full btn-primary text-white py-2 rounded-md font-semibold transition-colors duration-200">Войти</button>
                    <div id="login-message" class="mt-4 text-center"></div>
                </form>
                <div class="text-center my-4">или</div>
                <button id="google-login-btn" class="w-full bg-gray-600 text-white py-2 rounded-md font-semibold transition-colors duration-200 hover:bg-gray-700">
                    Войти через Google
                </button>
            </div>
        </section>

        <section id="student-dashboard" class="hidden p-8">
            <h2 class="text-3xl font-bold mb-6 text-ya_buxgalter">Личный кабинет студента</h2>
            <div id="dashboard-nav" class="flex space-x-4 mb-6 border-b border-gray-300">
                <button class="py-2 px-4 border-b-2 border-transparent hover:border-ya_buxgalter transition-colors duration-200" id="my-lessons-btn">Мои уроки</button>
                <button class="py-2 px-4 border-b-2 border-transparent hover:border-ya_buxgalter transition-colors duration-200" id="my-profile-btn">Мой профиль</button>
            </div>
            <div id="my-lessons-content" class="hidden">
                <h3 class="text-2xl font-semibold mb-4">Мои уроки</h3>
                <div id="lessons-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>
            <div id="my-profile-content" class="hidden">
                <h3 class="text-2xl font-semibold mb-4">Мой профиль</h3>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex items-center space-x-4 mb-4">
                        <img id="profile-avatar" src="https://via.placeholder.com/100" alt="Аватар" class="w-24 h-24 rounded-full object-cover">
                        <div>
                            <p id="profile-fio" class="font-bold text-xl">ФИО: </p>
                            <p id="profile-email" class="text-gray-600">Email: </p>
                            <p id="profile-group" class="text-gray-600">Группа: </p>
                        </div>
                    </div>
                    <h4 class="font-semibold text-lg mb-2">Курсы</h4>
                    <ul id="profile-courses" class="list-disc list-inside text-gray-700">
                        </ul>
                </div>
            </div>
        </section>

        <section id="admin-dashboard" class="hidden p-8">
            <h2 class="text-3xl font-bold mb-6 text-ya_buxgalter">Админ панель</h2>
            <div id="admin-nav" class="flex space-x-4 mb-6 border-b border-gray-300">
                <button class="py-2 px-4 border-b-2 border-transparent hover:border-ya_buxgalter transition-colors duration-200" id="lessons-btn">Уроки</button>
                <button class="py-2 px-4 border-b-2 border-transparent hover:border-ya_buxgalter transition-colors duration-200" id="students-btn">Студенты</button>
                <button class="py-2 px-4 border-b-2 border-transparent hover:border-ya_buxgalter transition-colors duration-200" id="groups-btn">Группы</button>
                <button class="py-2 px-4 border-b-2 border-transparent hover:border-ya_buxgalter transition-colors duration-200" id="applications-btn">Заявки</button>
            </div>
            
            <div id="lessons-content" class="hidden p-4 bg-white rounded-lg shadow-lg">
                <h3 class="text-2xl font-semibold mb-4">Управление уроками</h3>
                <div class="admin-panel-grid">
                    <div>
                        <h4 class="font-bold text-xl mb-4">Список уроков</h4>
                        <div id="lessons-table" class="overflow-x-auto">
                            </div>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-lg shadow-inner">
                        <h4 class="font-bold text-xl mb-4">Добавить/Редактировать урок</h4>
                        <form id="add-lesson-form" class="space-y-4">
                            <input type="hidden" id="edit-lesson-id">
                            <div>
                                <label for="lesson-title" class="block text-gray-700">Название урока</label>
                                <input type="text" id="lesson-title" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <div>
                                <label for="lesson-description" class="block text-gray-700">Описание</label>
                                <textarea id="lesson-description" rows="3" class="w-full px-3 py-2 border rounded-md"></textarea>
                            </div>
                            <div>
                                <label for="lesson-video" class="block text-gray-700">URL видео (YouTube)</label>
                                <input type="url" id="lesson-video" class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <div>
                                <label for="lesson-group" class="block text-gray-700">Группа</label>
                                <select id="lesson-group" class="w-full px-3 py-2 border rounded-md">
                                    </select>
                            </div>
                            <div>
                                <label for="lesson-file" class="block text-gray-700">Файл урока (PDF/PPT)</label>
                                <input type="file" id="lesson-file" class="w-full px-3 py-2 border rounded-md">
                            </div>
                            <button type="submit" class="w-full btn-primary text-white py-2 rounded-md">Сохранить урок</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="students-content" class="hidden p-4 bg-white rounded-lg shadow-lg">
                <h3 class="text-2xl font-semibold mb-4">Управление студентами</h3>
                <div class="admin-panel-grid">
                    <div>
                        <h4 class="font-bold text-xl mb-4">Список студентов</h4>
                        <div id="students-list" class="overflow-x-auto">
                            </div>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-lg shadow-inner">
                        <h4 class="font-bold text-xl mb-4">Добавить/Редактировать студента</h4>
                        <form id="add-student-form" class="space-y-4">
                            <div>
                                <label for="student-fio" class="block text-gray-700">ФИО</label>
                                <input type="text" id="student-fio" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <div>
                                <label for="student-email" class="block text-gray-700">Email студента</label>
                                <input type="email" id="student-email" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <div>
                                <label for="student-password" class="block text-gray-700">Пароль</label>
                                <input type="password" id="student-password" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <div>
                                <label for="student-group-select" class="block text-gray-700">Группа</label>
                                <select id="student-group-select" class="w-full px-3 py-2 border rounded-md">
                                    </select>
                            </div>
                            <button type="submit" class="w-full btn-primary text-white py-2 rounded-md">Сохранить студента</button>
                            <div id="add-student-message" class="mt-4 text-center"></div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div id="groups-content" class="hidden p-4 bg-white rounded-lg shadow-lg">
                <h3 class="text-2xl font-semibold mb-4">Управление группами</h3>
                <div class="admin-panel-grid">
                    <div>
                        <h4 class="font-bold text-xl mb-4">Список групп</h4>
                        <div id="group-list" class="overflow-x-auto">
                            </div>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-lg shadow-inner">
                        <h4 class="font-bold text-xl mb-4">Добавить/Редактировать группу</h4>
                        <form id="add-group-form" class="space-y-4">
                            <div>
                                <label for="group-name" class="block text-gray-700">Название группы</label>
                                <input type="text" id="group-name" class="w-full px-3 py-2 border rounded-md" required>
                            </div>
                            <button type="submit" class="w-full btn-primary text-white py-2 rounded-md">Добавить группу</button>
                            <div id="add-group-message" class="mt-4 text-center"></div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div id="applications-content" class="hidden p-4 bg-white rounded-lg shadow-lg">
                <h3 class="text-2xl font-semibold mb-4">Заявки на регистрацию</h3>
                <div id="applications-list" class="overflow-x-auto">
                    </div>
            </div>
        </section>

        <div id="enroll-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">Записаться на курс</h3>
                    <button id="close-enroll-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>
                <form id="enroll-form">
                    <div class="mb-4">
                        <label for="enroll-course-type" class="block text-gray-700 font-bold mb-2">Тип курса</label>
                        <select id="enroll-course-type" class="w-full px-3 py-2 border rounded-md" required>
                            <option value="">Выберите тип курса</option>
                            <option value="individual">Индивидуальный</option>
                            <option value="group">Группа</option>
                            <option value="online">Онлайн</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="enroll-name" class="block text-gray-700 font-bold mb-2">Имя</label>
                        <input type="text" id="enroll-name" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <div class="mb-4">
                        <label for="enroll-phone" class="block text-gray-700 font-bold mb-2">Номер телефона</label>
                        <input type="tel" id="enroll-phone" class="w-full px-3 py-2 border rounded-md" required>
                    </div>
                    <button type="submit" class="w-full btn-primary text-white py-2 rounded-md font-semibold transition-colors duration-200">Отправить заявку</button>
                    <div id="enroll-message" class="mt-4 text-center"></div>
                </form>
            </div>
        </div>

        <div id="contact-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">Связаться с нами</h3>
                    <button id="close-contact-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
                </div>
                <p class="mb-4 text-center">Вы можете связаться с нами по номеру:</p>
                <p class="text-2xl font-bold text-center text-ya_buxgalter mb-4">+998-94-800-00-68</p>
                <a href="https://t.me/ya_buxgalter_bot" target="_blank" class="w-full btn-primary text-white py-2 rounded-md text-center block font-semibold transition-colors duration-200">Написать в Telegram</a>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, deleteDoc, updateDoc, query, where } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-functions.js';

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = firebaseConfig.appId;

        // Theme Toggle
        const themeToggleBtn = document.getElementById('theme-toggle');
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        const body = document.body;

        themeToggleBtn.addEventListener('click', () => {
            body.classList.toggle('dark-theme');
            if (body.classList.contains('dark-theme')) {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        });

        // Logo functionality
        async function fetchLogoAndText() {
            try {
                const logoDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/logo/config`));
                if (logoDoc.exists()) {
                    const data = logoDoc.data();
                    const logoImage = document.getElementById('logo-image');
                    const logoText = document.getElementById('logo-text');
                    if (logoImage && data.logoUrl) logoImage.src = data.logoUrl;
                    if (logoText && data.text) logoText.textContent = data.text;
                }
            } catch (e) {
                console.error("Ошибка загрузки логотипа:", e);
            }
        }
        fetchLogoAndText();

        // UI elements
        const mainPageSection = document.getElementById('main-page-section');
        const loginSection = document.getElementById('login-section');
        const studentDashboard = document.getElementById('student-dashboard');
        const adminDashboard = document.getElementById('admin-dashboard');

        const loginBtnNav = document.getElementById('login-btn-nav');
        const contactBtnNav = document.getElementById('contact-btn-nav');
        const enrollNowBtn = document.getElementById('enroll-now-btn');
        const logoutBtn = document.getElementById('logout-btn');

        const enrollModal = document.getElementById('enroll-modal');
        const closeEnrollModal = document.getElementById('close-enroll-modal');
        const enrollForm = document.getElementById('enroll-form');
        const enrollMessage = document.getElementById('enroll-message');

        const contactModal = document.getElementById('contact-modal');
        const closeContactModal = document.getElementById('close-contact-modal');

        // Admin nav elements
        const lessonsBtn = document.getElementById('lessons-btn');
        const studentsBtn = document.getElementById('students-btn');
        const groupsBtn = document.getElementById('groups-btn');
        const applicationsBtn = document.getElementById('applications-btn');

        const lessonsContent = document.getElementById('lessons-content');
        const studentsContent = document.getElementById('students-content');
        const groupsContent = document.getElementById('groups-content');
        const applicationsContent = document.getElementById('applications-content');

        // Student nav elements
        const myLessonsBtn = document.getElementById('my-lessons-btn');
        const myProfileBtn = document.getElementById('my-profile-btn');
        const myLessonsContent = document.getElementById('my-lessons-content');
        const myProfileContent = document.getElementById('my-profile-content');

        const userInfo = document.getElementById('user-info');
        const guestInfo = document.getElementById('guest-info');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const userRole = document.getElementById('user-role');
        const profileFio = document.getElementById('profile-fio');
        const profileEmail = document.getElementById('profile-email');
        const profileGroup = document.getElementById('profile-group');
        const profileCourses = document.getElementById('profile-courses');

        // Show/hide sections
        function showSection(sectionId) {
            const sections = [mainPageSection, loginSection, studentDashboard, adminDashboard];
            sections.forEach(sec => sec.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // Show/hide modals
        function showModal(modal) {
            modal.classList.remove('hidden');
        }
        function hideModal(modal) {
            modal.classList.add('hidden');
        }

        // Event listeners for modals
        enrollNowBtn.addEventListener('click', () => showModal(enrollModal));
        closeEnrollModal.addEventListener('click', () => hideModal(enrollModal));
        contactBtnNav.addEventListener('click', () => showModal(contactModal));
        closeContactModal.addEventListener('click', () => hideModal(contactModal));
        loginBtnNav.addEventListener('click', () => {
            hideModal(contactModal);
            showSection('login-section');
        });

        // Application form submission
        enrollForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('enroll-name').value;
            const phone = document.getElementById('enroll-phone').value;
            const courseType = document.getElementById('enroll-course-type').value;

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/applications`), {
                    name: name,
                    phone: phone,
                    courseType: courseType,
                    createdAt: new Date()
                });
                enrollMessage.textContent = 'Заявка успешно отправлена!';
                enrollMessage.classList.remove('text-red-500');
                enrollMessage.classList.add('text-green-500');
                enrollForm.reset();
                setTimeout(() => hideModal(enrollModal), 2000);
            } catch (error) {
                console.error("Error adding document: ", error);
                enrollMessage.textContent = 'Ошибка при отправке заявки.';
                enrollMessage.classList.remove('text-green-500');
                enrollMessage.classList.add('text-red-500');
            }
        });

        // Auth state change listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                guestInfo.classList.add('hidden');
                userInfo.classList.remove('hidden');
                try {
                    const userRef = doc(db, "users", user.uid);
                    const userSnap = await getDoc(userRef);
                    let userData;
                    if (userSnap.exists()) {
                        userData = userSnap.data();
                    } else {
                        // For new Google users, create a profile
                        userData = {
                            fio: user.displayName || 'Пользователь',
                            email: user.email,
                            photoURL: user.photoURL,
                            role: 'student' // default role for new users
                        };
                        await setDoc(userRef, userData, { merge: true });
                    }
                    
                    userName.textContent = userData.fio || 'Пользователь';
                    userRole.textContent = userData.role || 'Студент';
                    userAvatar.src = userData.photoURL || "https://via.placeholder.com/40";
                    
                    if (userData.role === 'admin') {
                        showSection('admin-dashboard');
                        loadAdminPanel();
                    } else {
                        showSection('student-dashboard');
                        loadStudentDashboard(user.uid);
                    }
                } catch (e) {
                    console.error("Ошибка загрузки данных пользователя:", e);
                    showSection('login-section');
                }
            } else {
                guestInfo.classList.remove('hidden');
                userInfo.classList.add('hidden');
                showSection('main-page-section');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                location.reload(); // Reload the page after logout
            } catch (e) {
                console.error("Ошибка выхода:", e);
            }
        });

        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginMessage = document.getElementById('login-message');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmail.value;
            const password = loginPassword.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginMessage.textContent = 'Вход выполнен. Перенаправление...';
                loginMessage.classList.remove('text-red-500');
                loginMessage.classList.add('text-green-500');
            } catch (error) {
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    loginMessage.textContent = 'Неверный Email или пароль.';
                } else {
                    loginMessage.textContent = `Ошибка входа: ${error.message}`;
                }
                loginMessage.classList.remove('text-green-500');
                loginMessage.classList.add('text-red-500');
                console.error("Ошибка входа:", error);
            }
        });

        const googleLoginBtn = document.getElementById('google-login-btn');
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                loginMessage.textContent = 'Вход выполнен. Перенаправление...';
                loginMessage.classList.remove('text-red-500');
                loginMessage.classList.add('text-green-500');
            } catch (error) {
                console.error("Ошибка входа через Google:", error);
                loginMessage.textContent = `Ошибка входа через Google: ${error.message}`;
                loginMessage.classList.remove('text-green-500');
                loginMessage.classList.add('text-red-500');
            }
        });

        // Student Dashboard Functions
        function loadStudentDashboard(uid) {
            myLessonsBtn.click();
            loadStudentProfile(uid);
        }

        async function loadStudentProfile(uid) {
            try {
                const userRef = doc(db, "users", uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    profileFio.textContent = `ФИО: ${userData.fio || 'Не указано'}`;
                    profileEmail.textContent = `Email: ${userData.email || 'Не указан'}`;
                    profileGroup.textContent = `Группа: ${userData.group || 'Не назначена'}`;
                    userAvatar.src = userData.photoURL || "https://via.placeholder.com/100";
                    profileAvatar.src = userData.photoURL || "https://via.placeholder.com/100";
                    profileCourses.innerHTML = '';
                    if (userData.courses && userData.courses.length > 0) {
                        userData.courses.forEach(course => {
                            const li = document.createElement('li');
                            li.textContent = course;
                            profileCourses.appendChild(li);
                        });
                    } else {
                        profileCourses.textContent = 'Курсы не найдены.';
                    }
                }
            } catch (e) {
                console.error("Ошибка загрузки профиля:", e);
            }
        }

        async function loadStudentLessons() {
            const user = auth.currentUser;
            if (!user) return;

            const lessonsList = document.getElementById('lessons-list');
            lessonsList.innerHTML = 'Загрузка уроков...';

            try {
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                const userData = userSnap.data();
                if (!userData || !userData.group) {
                    lessonsList.textContent = 'Вы не назначены в группу.';
                    return;
                }
                const groupId = userData.group;
                
                const lessonsRef = collection(db, `artifacts/${appId}/public/data/groups/${groupId}/lessons`);
                const lessonsSnap = await getDocs(lessonsRef);
                
                if (lessonsSnap.empty) {
                    lessonsList.textContent = 'Уроки для вашей группы пока не добавлены.';
                    return;
                }

                lessonsList.innerHTML = '';
                lessonsSnap.forEach(lessonDoc => {
                    const lesson = lessonDoc.data();
                    const lessonCard = document.createElement('div');
                    lessonCard.className = 'bg-white p-6 rounded-lg shadow-lg';
                    lessonCard.innerHTML = `
                        <h4 class="font-bold text-lg text-ya_buxgalter">${lesson.title}</h4>
                        <p class="text-gray-600 mb-4">${lesson.description || ''}</p>
                        ${lesson.videoUrl ? `<a href="${lesson.videoUrl}" target="_blank" class="text-blue-500 hover:underline block mb-2">Смотреть видео</a>` : ''}
                        ${lesson.fileUrl ? `<a href="${lesson.fileUrl}" target="_blank" class="text-blue-500 hover:underline block">Скачать файл</a>` : ''}
                    `;
                    lessonsList.appendChild(lessonCard);
                });
            } catch (e) {
                console.error("Ошибка загрузки уроков:", e);
                lessonsList.textContent = 'Ошибка загрузки уроков.';
            }
        }

        // Student nav logic
        const studentNavButtons = document.querySelectorAll('#dashboard-nav button');
        studentNavButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                studentNavButtons.forEach(b => b.classList.remove('border-ya_buxgalter'));
                e.target.classList.add('border-ya_buxgalter');
                myLessonsContent.classList.add('hidden');
                myProfileContent.classList.add('hidden');
                if (e.target.id === 'my-lessons-btn') {
                    myLessonsContent.classList.remove('hidden');
                    loadStudentLessons();
                } else if (e.target.id === 'my-profile-btn') {
                    myProfileContent.classList.remove('hidden');
                    loadStudentProfile(auth.currentUser.uid);
                }
            });
        });
        
        // Admin Panel Functions
        function loadAdminPanel() {
            lessonsBtn.click();
        }

        const adminNavButtons = document.querySelectorAll('#admin-nav button');
        adminNavButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                adminNavButtons.forEach(b => b.classList.remove('border-ya_buxgalter'));
                e.target.classList.add('border-ya_buxgalter');
                lessonsContent.classList.add('hidden');
                studentsContent.classList.add('hidden');
                groupsContent.classList.add('hidden');
                applicationsContent.classList.add('hidden');
                
                if (e.target.id === 'lessons-btn') {
                    lessonsContent.classList.remove('hidden');
                    loadLessonsTable();
                    loadGroupOptions(document.getElementById('lesson-group'));
                } else if (e.target.id === 'students-btn') {
                    studentsContent.classList.remove('hidden');
                    loadStudentsTable();
                    loadGroupOptions(document.getElementById('student-group-select'));
                } else if (e.target.id === 'groups-btn') {
                    groupsContent.classList.remove('hidden');
                    loadGroupsList();
                } else if (e.target.id === 'applications-btn') {
                    applicationsContent.classList.remove('hidden');
                    loadApplications();
                }
            });
        });
        
        async function loadGroupOptions(selectElement) {
            selectElement.innerHTML = '<option value="">Выберите группу</option>';
            try {
                const groupsRef = collection(db, `artifacts/${appId}/public/data/groups`);
                const groupsSnap = await getDocs(groupsRef);
                groupsSnap.forEach(groupDoc => {
                    const group = groupDoc.data();
                    const option = document.createElement('option');
                    option.value = groupDoc.id;
                    option.textContent = group.name;
                    selectElement.appendChild(option);
                });
            } catch (e) {
                console.error("Ошибка загрузки групп:", e);
            }
        }

        // Lessons
        const addLessonForm = document.getElementById('add-lesson-form');
        const lessonTitleInput = document.getElementById('lesson-title');
        const lessonDescriptionInput = document.getElementById('lesson-description');
        const lessonVideoInput = document.getElementById('lesson-video');
        const lessonGroupInput = document.getElementById('lesson-group');
        const lessonFileInput = document.getElementById('lesson-file');
        const editLessonIdInput = document.getElementById('edit-lesson-id');

        addLessonForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lessonTitle = lessonTitleInput.value;
            const lessonDescription = lessonDescriptionInput.value;
            const lessonVideo = lessonVideoInput.value;
            const groupId = lessonGroupInput.value;
            const lessonId = editLessonIdInput.value;
            const file = lessonFileInput.files[0];

            if (!groupId) {
                alert('Пожалуйста, выберите группу.');
                return;
            }

            let fileUrl = '';
            if (file) {
                try {
                    const fileRef = ref(storage, `artifacts/${appId}/public/files/${file.name}`);
                    await uploadBytes(fileRef, file);
                    fileUrl = await getDownloadURL(fileRef);
                } catch (e) {
                    console.error("Ошибка загрузки файла:", e);
                    alert("Ошибка загрузки файла.");
                    return;
                }
            }

            try {
                if (lessonId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/groups/${groupId}/lessons`, lessonId), {
                        title: lessonTitle,
                        description: lessonDescription,
                        videoUrl: lessonVideo,
                        fileUrl: fileUrl || undefined
                    });
                    alert('Урок успешно обновлен!');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/groups/${groupId}/lessons`), {
                        title: lessonTitle,
                        description: lessonDescription,
                        videoUrl: lessonVideo,
                        fileUrl: fileUrl || undefined,
                        createdAt: new Date()
                    });
                    alert('Урок успешно добавлен!');
                }
                addLessonForm.reset();
                editLessonIdInput.value = '';
                loadLessonsTable();
            } catch (e) {
                console.error("Ошибка сохранения урока:", e);
                alert("Ошибка сохранения урока.");
            }
        });

        async function loadLessonsTable() {
            const lessonsTable = document.getElementById('lessons-table');
            lessonsTable.innerHTML = '<p>Загрузка уроков...</p>';

            try {
                const groupsRef = collection(db, `artifacts/${appId}/public/data/groups`);
                const groupsSnap = await getDocs(groupsRef);
                let lessonsHtml = `<table class="min-w-full bg-white border border-gray-200">
                                    <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                        <tr>
                                            <th class="py-3 px-6 text-left">Название урока</th>
                                            <th class="py-3 px-6 text-left">Группа</th>
                                            <th class="py-3 px-6 text-left">Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-gray-600 text-sm font-light">`;

                for (const groupDoc of groupsSnap.docs) {
                    const groupId = groupDoc.id;
                    const groupName = groupDoc.data().name;
                    const lessonsRef = collection(db, `artifacts/${appId}/public/data/groups/${groupId}/lessons`);
                    const lessonsSnap = await getDocs(lessonsRef);
                    lessonsSnap.forEach(lessonDoc => {
                        const lesson = lessonDoc.data();
                        lessonsHtml += `<tr class="border-b border-gray-200 hover:bg-gray-100">
                                            <td class="py-3 px-6 text-left whitespace-nowrap">${lesson.title}</td>
                                            <td class="py-3 px-6 text-left">${groupName}</td>
                                            <td class="py-3 px-6 text-left">
                                                <button data-id="${lessonDoc.id}" data-groupid="${groupId}" class="edit-lesson-btn text-blue-500 hover:text-blue-700 font-semibold mr-2">Редактировать</button>
                                                <button data-id="${lessonDoc.id}" data-groupid="${groupId}" class="delete-lesson-btn text-red-500 hover:text-red-700 font-semibold">Удалить</button>
                                            </td>
                                        </tr>`;
                    });
                }
                lessonsHtml += `</tbody></table>`;
                lessonsTable.innerHTML = lessonsHtml;

                lessonsTable.addEventListener('click', async (e) => {
                    const target = e.target;
                    if (target.classList.contains('delete-lesson-btn')) {
                        const lessonId = target.dataset.id;
                        const groupId = target.dataset.groupid;
                        if (confirm('Вы уверены, что хотите удалить этот урок?')) {
                            try {
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/groups/${groupId}/lessons`, lessonId));
                                alert('Урок успешно удален!');
                                loadLessonsTable();
                            } catch (e) {
                                console.error("Ошибка удаления урока:", e);
                                alert("Ошибка удаления урока.");
                            }
                        }
                    }
                    if (target.classList.contains('edit-lesson-btn')) {
                        const lessonId = target.dataset.id;
                        const groupId = target.dataset.groupid;
                        try {
                            const lessonDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/groups/${groupId}/lessons`, lessonId));
                            if (lessonDoc.exists()) {
                                const lessonData = lessonDoc.data();
                                editLessonIdInput.value = lessonId;
                                lessonTitleInput.value = lessonData.title;
                                lessonDescriptionInput.value = lessonData.description || '';
                                lessonVideoInput.value = lessonData.videoUrl || '';
                                lessonGroupInput.value = groupId;
                            }
                        } catch (e) {
                            console.error("Ошибка загрузки урока для редактирования:", e);
                            alert("Ошибка загрузки урока для редактирования.");
                        }
                    }
                });

            } catch (e) {
                console.error("Ошибка загрузки уроков:", e);
                lessonsTable.innerHTML = '<p>Ошибка загрузки уроков.</p>';
            }
        }

        // Students
        const addStudentForm = document.getElementById('add-student-form');
        const addStudentMessage = document.getElementById('add-student-message');
        addStudentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fio = document.getElementById('student-fio').value;
            const email = document.getElementById('student-email').value;
            const password = document.getElementById('student-password').value;
            const groupId = document.getElementById('student-group-select').value;
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    fio: fio,
                    email: email,
                    group: groupId,
                    role: 'student'
                });
                addStudentMessage.textContent = 'Студент успешно добавлен!';
                addStudentMessage.classList.remove('text-red-500');
                addStudentMessage.classList.add('text-green-500');
                addStudentForm.reset();
                loadStudentsTable();
            } catch (e) {
                console.error("Ошибка добавления студента:", e);
                addStudentMessage.textContent = `Ошибка добавления студента: ${e.message}`;
                addStudentMessage.classList.remove('text-green-500');
                addStudentMessage.classList.add('text-red-500');
            }
        });

        async function loadStudentsTable() {
            const studentsList = document.getElementById('students-list');
            studentsList.innerHTML = '<p>Загрузка студентов...</p>';
            try {
                const usersRef = collection(db, "users");
                const usersSnap = await getDocs(query(usersRef, where("role", "==", "student")));
                let studentsHtml = `<table class="min-w-full bg-white border border-gray-200">
                                    <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                        <tr>
                                            <th class="py-3 px-6 text-left">ФИО</th>
                                            <th class="py-3 px-6 text-left">Email</th>
                                            <th class="py-3 px-6 text-left">Группа</th>
                                            <th class="py-3 px-6 text-left">Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-gray-600 text-sm font-light">`;
                for (const userDoc of usersSnap.docs) {
                    const userData = userDoc.data();
                    const groupName = userData.group ? (await getDoc(doc(db, `artifacts/${appId}/public/data/groups`, userData.group))).data()?.name || 'Не назначена' : 'Не назначена';
                    studentsHtml += `<tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-3 px-6 text-left whitespace-nowrap">${userData.fio || 'N/A'}</td>
                                        <td class="py-3 px-6 text-left">${userData.email || 'N/A'}</td>
                                        <td class="py-3 px-6 text-left">${groupName}</td>
                                        <td class="py-3 px-6 text-left">
                                            <button data-id="${userDoc.id}" class="edit-student-btn text-blue-500 hover:text-blue-700 font-semibold mr-2">Редактировать</button>
                                            <button data-id="${userDoc.id}" class="delete-student-btn text-red-500 hover:text-red-700 font-semibold">Удалить</button>
                                            <button data-id="${userDoc.id}" class="transfer-student-btn text-green-500 hover:text-green-700 font-semibold">Переместить</button>
                                        </td>
                                    </tr>`;
                }
                studentsHtml += `</tbody></table>`;
                studentsList.innerHTML = studentsHtml;

                studentsList.addEventListener('click', async (e) => {
                    const target = e.target;
                    const studentId = target.dataset.id;
                    if (target.classList.contains('delete-student-btn')) {
                        if (confirm('Вы уверены, что хотите удалить этого студента?')) {
                            try {
                                await deleteDoc(doc(db, "users", studentId));
                                alert('Студент успешно удален!');
                                loadStudentsTable();
                            } catch (e) {
                                console.error("Ошибка удаления студента:", e);
                                alert("Ошибка удаления студента.");
                            }
                        }
                    }
                    if (target.classList.contains('transfer-student-btn')) {
                        const newGroupId = prompt('Введите ID новой группы:');
                        if (newGroupId) {
                            try {
                                await updateDoc(doc(db, "users", studentId), { group: newGroupId });
                                alert('Студент успешно перемещен!');
                                loadStudentsTable();
                            } catch (e) {
                                console.error("Ошибка перемещения студента:", e);
                                alert("Ошибка перемещения студента.");
                            }
                        }
                    }
                });

            } catch (e) {
                console.error("Ошибка загрузки студентов:", e);
                studentsList.innerHTML = '<p>Ошибка загрузки студентов.</p>';
            }
        }

        // Groups
        const addGroupForm = document.getElementById('add-group-form');
        const addGroupMessage = document.getElementById('add-group-message');
        addGroupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupName = document.getElementById('group-name').value;
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/groups`), { name: groupName, createdAt: new Date() });
                addGroupMessage.textContent = 'Группа успешно добавлена!';
                addGroupMessage.classList.remove('text-red-500');
                addGroupMessage.classList.add('text-green-500');
                addGroupForm.reset();
                loadGroupsList();
            } catch (e) {
                console.error("Ошибка добавления группы:", e);
                addGroupMessage.textContent = 'Ошибка добавления группы.';
                addGroupMessage.classList.remove('text-green-500');
                addGroupMessage.classList.add('text-red-500');
            }
        });

        async function loadGroupsList() {
            const groupList = document.getElementById('group-list');
            groupList.innerHTML = '<p>Загрузка групп...</p>';
            try {
                const groupsRef = collection(db, `artifacts/${appId}/public/data/groups`);
                const groupsSnap = await getDocs(groupsRef);
                let groupsHtml = `<ul class="list-disc pl-5 space-y-2">`;
                for (const groupDoc of groupsSnap.docs) {
                    const group = groupDoc.data();
                    const studentsInGroupRef = collection(db, `users`);
                    const studentsSnap = await getDocs(query(studentsInGroupRef, where('group', '==', groupDoc.id)));
                    const studentCount = studentsSnap.size;
                    groupsHtml += `<li class="p-2 border rounded-md hover:bg-gray-50">
                                    <div class="flex justify-between items-center">
                                        <span>${group.name} (${studentCount} студентов)</span>
                                        <div>
                                            <button data-id="${groupDoc.id}" class="delete-group-btn text-red-500 hover:text-red-700 font-semibold ml-2">Удалить</button>
                                        </div>
                                    </div>
                                    <ul id="students-in-${groupDoc.id}" class="list-none pl-4 mt-2 hidden"></ul>
                                </li>`;
                }
                groupsHtml += `</ul>`;
                groupList.innerHTML = groupsHtml;
            } catch (e) {
                console.error("Ошибка загрузки групп:", e);
                groupList.innerHTML = '<p>Ошибка загрузки групп.</p>';
            }
        }
        
        // Applications
        async function loadApplications() {
            const applicationsList = document.getElementById('applications-list');
            applicationsList.innerHTML = '<p>Загрузка заявок...</p>';
            try {
                const applicationsRef = collection(db, `artifacts/${appId}/public/data/applications`);
                const applicationsSnap = await getDocs(applicationsRef);
                if (applicationsSnap.empty) {
                    applicationsList.innerHTML = '<p>Заявок пока нет.</p>';
                    return;
                }
                let appsHtml = `<table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <tr>
                                        <th class="py-3 px-6 text-left">Имя</th>
                                        <th class="py-3 px-6 text-left">Телефон</th>
                                        <th class="py-3 px-6 text-left">Курс</th>
                                        <th class="py-3 px-6 text-left">Дата</th>
                                    </tr>
                                </thead>
                                <tbody class="text-gray-600 text-sm font-light">`;
                applicationsSnap.forEach(appDoc => {
                    const appData = appDoc.data();
                    appsHtml += `<tr class="border-b border-gray-200 hover:bg-gray-100">
                                    <td class="py-3 px-6 text-left whitespace-nowrap">${appData.name}</td>
                                    <td class="py-3 px-6 text-left">${appData.phone}</td>
                                    <td class="py-3 px-6 text-left">${appData.courseType}</td>
                                    <td class="py-3 px-6 text-left">${appData.createdAt.toDate().toLocaleString()}</td>
                                </tr>`;
                });
                appsHtml += `</tbody></table>`;
                applicationsList.innerHTML = appsHtml;
            } catch (e) {
                console.error("Ошибка загрузки заявок:", e);
                applicationsList.innerHTML = '<p>Ошибка загрузки заявок.</p>';
            }
        }
    </script>
</body>
</html>
