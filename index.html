<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asonik AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключаем Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // Глобальные переменные для Firebase
        let app, db, auth, functions;
        // Глобальная переменная для отслеживания состояния авторизации
        let isAuthReady = false;
        // Глобальная переменная для userId
        let userId;
        // Глобальная переменная для appId
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Конфигурация Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Настройки для входа по ссылке
        const actionCodeSettings = {
            url: window.location.href, // Используем текущий URL
            handleCodeInApp: true,
        };
        
        // Функция для отображения кастомного сообщения
        const showMessage = (message) => {
            const messageBox = document.createElement('div');
            messageBox.className = 'message-box p-4 bg-gray-800 text-white rounded-lg shadow-xl text-center';
            messageBox.textContent = message;
            document.body.appendChild(messageBox);
            setTimeout(() => {
                messageBox.remove();
            }, 3000);
        };
        
        // Рендер страницы входа
        const renderSignInPage = () => {
            const mainContentDiv = document.getElementById('main-content');
            if (!mainContentDiv) return;

            mainContentDiv.innerHTML = `
                <div class="flex flex-col items-center w-full max-w-sm p-8 bg-gray-900 bg-opacity-75 rounded-3xl shadow-2xl backdrop-filter backdrop-blur-md border border-gray-700">
                    <h2 class="text-3xl font-bold text-white mb-6">Добро пожаловать!</h2>
                    <p class="text-gray-400 text-center mb-8">
                        Войдите, чтобы получить доступ к различным AI-моделям.
                    </p>
                    <div class="flex flex-col space-y-4 w-full">
                        <button id="googleSignInButton" class="w-full px-6 py-3 bg-white text-gray-900 font-semibold rounded-full hover:bg-gray-200 transition duration-300 shadow-lg flex items-center justify-center">
                            <svg class="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12.0001 4.75001C14.0084 4.75001 15.8202 5.4856 17.2003 6.78653L20.0337 3.95319C17.9377 2.01633 15.1107 0.999998 12.0001 0.999998C7.62537 0.999998 3.86146 3.40058 1.93375 7.15197L5.61793 9.99222C6.54922 8.35821 8.16782 7.25001 10.0001 7.25001C10.6698 7.25001 11.3195 7.35628 11.9333 7.56191L12.0001 7.58552V4.75001Z" />
                                <path d="M22.0001 12.0001C22.0001 11.107 21.8797 10.2526 21.657 9.45899H12.0001V14.5412H18.7845C18.4283 16.3242 17.3093 17.8018 15.756 18.788L19.4633 21.6033C20.6722 19.8973 21.5001 17.8073 21.8906 15.5833H21.9991C22.0001 15.0601 22.0001 12.0001 22.0001 12.0001Z" />
                                <path d="M10.0001 16.75C8.16782 16.75 6.54922 15.6418 5.61793 14.0078L1.93375 16.8481C3.86146 20.5995 7.62537 23.0001 12.0001 23.0001C15.1107 23.0001 17.9377 21.9837 20.0337 20.0469L17.2003 17.2135C15.8202 18.5144 14.0084 19.25 12.0001 19.25C10.6698 19.25 10.0001 19.25 10.0001 19.25C8.16782 19.25 6.54922 18.1418 5.61793 16.0078L1.93375 18.8481L5.61793 21.6883C6.54922 23.3223 8.16782 24.4305 10.0001 24.4305C10.6698 24.4305 11.3195 24.3242 11.9333 24.1186L12.0001 24.0949C12.0001 24.0949 12.0001 24.0949 12.0001 24.0949Z" />
                                <path d="M12.0001 16.75V24.0949C12.0001 24.0949 12.0001 24.0949 12.0001 24.0949Z" />
                                <path d="M12.0001 7.25001C11.3304 7.25001 10.6807 7.14374 10.0669 6.93811L10.0001 6.9145V14.5412H21.657C21.8797 13.7475 22.0001 12.8931 22.0001 12.0001C22.0001 11.107 21.8797 10.2526 21.657 9.45899H12.0001V4.75001H12.0001Z" />
                            </svg>
                            Войти через Google
                        </button>
                        <button id="emailSignInButton" class="w-full px-6 py-3 bg-white text-gray-900 font-semibold rounded-full hover:bg-gray-200 transition duration-300 shadow-lg flex items-center justify-center">
                            <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            Войти через почту
                        </button>
                        <button id="phoneSignInButton" class="w-full px-6 py-3 bg-white text-gray-900 font-semibold rounded-full hover:bg-gray-200 transition duration-300 shadow-lg flex items-center justify-center">
                            <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                            </svg>
                            Войти через телефон
                        </button>
                    </div>
                </div>
            `;
            // Добавляем обработчики событий
            document.getElementById('googleSignInButton').addEventListener('click', () => {
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider).catch(error => console.error("Google Sign-In Error:", error));
            });
            document.getElementById('emailSignInButton').addEventListener('click', renderEmailForm);
            document.getElementById('phoneSignInButton').addEventListener('click', renderPhoneForm);
        };
        
        // Рендер формы входа по почте
        const renderEmailForm = () => {
            const mainContentDiv = document.getElementById('main-content');
            mainContentDiv.innerHTML = `
                <div class="flex flex-col items-center w-full max-w-sm p-8 bg-gray-900 bg-opacity-75 rounded-3xl shadow-2xl backdrop-filter backdrop-blur-md border border-gray-700">
                    <h2 class="text-3xl font-bold text-white mb-6">Вход по ссылке</h2>
                    <input type="email" id="emailInput" placeholder="Введите почту" class="w-full p-3 mb-4 rounded-full border border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button id="sendLinkButton" class="w-full px-6 py-3 bg-purple-600 text-white font-semibold rounded-full hover:bg-purple-700 transition duration-300 shadow-lg">
                        Отправить ссылку для входа
                    </button>
                    <button id="backToSignInOptions" class="mt-4 w-full px-6 py-3 text-white font-semibold rounded-full transition duration-300 hover:text-purple-400">
                        Назад
                    </button>
                </div>
            `;
            document.getElementById('sendLinkButton').addEventListener('click', async () => {
                const email = document.getElementById('emailInput').value;
                if (email) {
                    try {
                        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                        window.localStorage.setItem('emailForSignIn', email);
                        showMessage(`Ссылка для входа отправлена на почту ${email}.`);
                    } catch (error) {
                        console.error("Email Link Auth Error:", error);
                        showMessage(error.message);
                    }
                } else {
                    showMessage("Пожалуйста, введите корректный адрес почты.");
                }
            });
            document.getElementById('backToSignInOptions').addEventListener('click', renderUI);
        };
        
        // Рендер формы входа по телефону (пока заглушка)
        const renderPhoneForm = () => {
            const mainContentDiv = document.getElementById('main-content');
            mainContentDiv.innerHTML = `
                <div class="flex flex-col items-center w-full max-w-sm p-8 bg-gray-900 bg-opacity-75 rounded-3xl shadow-2xl backdrop-filter backdrop-blur-md border border-gray-700">
                    <h2 class="text-3xl font-bold text-white mb-6">Вход с помощью телефона</h2>
                    <p class="text-gray-400 text-center mb-4">Эта функция в настоящее время находится в разработке.</p>
                    <button id="backToSignInOptions" class="mt-4 w-full px-6 py-3 bg-purple-600 text-white font-semibold rounded-full hover:bg-purple-700 transition duration-300 shadow-lg">
                        Назад
                    </button>
                </div>
            `;
            document.getElementById('backToSignInOptions').addEventListener('click', renderUI);
        };

        // Рендер главной страницы с выбором AI
        const renderMainContent = (user) => {
            const mainContentDiv = document.getElementById('main-content');
            const chatSection = document.getElementById('chat-input-section');
            if (!mainContentDiv || !chatSection) return;

            mainContentDiv.innerHTML = `
                <div class="flex flex-col items-center w-full max-w-lg p-8 bg-gray-900 bg-opacity-75 rounded-3xl shadow-2xl backdrop-filter backdrop-blur-md border border-gray-700">
                    <h2 class="text-3xl font-bold text-white mb-6">Выберите AI-модель</h2>
                    <p class="text-gray-400 text-center mb-8">
                        ${user.displayName ? `Привет, ${user.displayName.split(' ')[0]}!` : 'Привет!'} Выбери, с кем хочешь пообщаться.
                    </p>
                    <div class="flex flex-col space-y-4 w-full">
                        <button id="asonikAiButton" class="w-full px-6 py-4 bg-purple-600 text-white font-semibold rounded-2xl hover:bg-purple-700 transition duration-300 shadow-lg text-left">
                            <span class="text-lg">Asonik AI</span><br>
                            <span class="text-sm">В разработке</span>
                        </button>
                        <button id="geminiButton" class="w-full px-6 py-4 bg-indigo-600 text-white font-semibold rounded-2xl hover:bg-indigo-700 transition duration-300 shadow-lg text-left">
                            <span class="text-lg">Gemini</span><br>
                            <span class="text-sm">В разработке</span>
                        </button>
                        <button id="otherButton" class="w-full px-6 py-4 bg-gray-600 text-white font-semibold rounded-2xl hover:bg-gray-700 transition duration-300 shadow-lg text-left">
                            <span class="text-lg">Другие AI-модели</span><br>
                            <span class="text-sm">Скоро...</span>
                        </button>
                    </div>
                </div>
            `;
            chatSection.classList.add('hidden'); // Скрываем панель чата на странице выбора AI

            // Добавляем обработчики событий
            document.getElementById('asonikAiButton').addEventListener('click', () => { showMessage("Asonik AI пока в разработке."); });
            document.getElementById('geminiButton').addEventListener('click', () => { showMessage("Gemini пока в разработке."); });
            document.getElementById('otherButton').addEventListener('click', () => { showMessage("Другие AI-модели пока в разработке."); });
        };

        // Рендер хедера (панели навигации)
        const renderHeader = (user) => {
            const authInfoDiv = document.getElementById('auth-info');
            if (!authInfoDiv) return;

            if (user) {
                // Пользователь авторизован
                const userDisplayName = user.displayName || 'Профиль';
                const userPhotoURL = user.photoURL || 'https://placehold.co/40x40/9CA3AF/FFFFFF?text=A'; // Заглушка
                authInfoDiv.innerHTML = `
                    <div class="flex items-center space-x-2 cursor-pointer group relative">
                        <img src="${userPhotoURL}" alt="Profile" class="w-10 h-10 rounded-full ring-2 ring-purple-500 dark:ring-purple-300">
                        <span class="text-base font-semibold text-white hidden md:block">${userDisplayName}</span>
                        <div class="absolute right-0 top-full mt-2 w-48 bg-gray-800 rounded-lg shadow-lg py-2 hidden group-hover:block z-50">
                            <p class="px-4 py-2 text-sm font-medium text-gray-200">${user.email || 'Нет Email'}</p>
                            <button id="signOutButton" class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-gray-700 transition duration-200">
                                Выйти
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('signOutButton').addEventListener('click', () => {
                    signOut(auth).catch(error => console.error("Sign-Out Error:", error));
                });
            } else {
                // Пользователь не авторизован
                authInfoDiv.innerHTML = `
                    <button id="signInButtonHeader" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-full hover:bg-purple-700 transition duration-300 shadow-md">
                        Войти
                    </button>
                `;
                document.getElementById('signInButtonHeader').addEventListener('click', renderSignInPage);
            }
        };

        // Главная функция рендеринга UI
        const renderUI = (user) => {
            renderHeader(user);
            if (user) {
                renderMainContent(user);
            } else {
                renderSignInPage();
            }
        };

        window.onload = async () => {
            try {
                // Инициализируем Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Слушатель состояния аутентификации
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        userId = null;
                    }
                    isAuthReady = true;
                    renderUI(user);
                });

                // Проверяем, является ли URL ссылкой для входа по почте
                if (isSignInWithEmailLink(auth, window.location.href)) {
                    let email = window.localStorage.getItem('emailForSignIn');
                    if (!email) {
                        email = window.prompt('Пожалуйста, введите вашу почту для завершения входа.');
                    }
                    if (email) {
                        try {
                            await signInWithEmailLink(auth, email, window.location.href);
                            window.localStorage.removeItem('emailForSignIn');
                            // Перенаправляем на главную страницу, чтобы убрать параметры ссылки из URL
                            window.history.replaceState({}, document.title, window.location.pathname);
                            showMessage("Вы успешно вошли в систему!");
                        } catch (error) {
                            console.error("Email Link Auth Error:", error);
                            showMessage(error.message);
                        }
                    } else {
                        showMessage("Вход отменен.");
                    }
                }
                
                // Обработка начальной авторизации
                const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (__initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token).catch(e => console.error('Custom token sign-in error:', e));
                } else {
                    await signInAnonymously(auth).catch(e => console.error('Anonymous sign-in error:', e));
                }

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                const mainContentDiv = document.getElementById('main-content');
                if (mainContentDiv) {
                    mainContentDiv.innerHTML = `
                        <p class="text-red-500 font-semibold text-center">
                            Ошибка инициализации Firebase. Пожалуйста, проверьте консоль.
                        </p>
                    `;
                }
            }
        };
    </script>
    <style>
        /* Общий стиль для боди */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #0d1117;
            color: #ffffff;
            overflow: hidden;
        }

        /* Анимированный фон "Звездное небо" */
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
            animation: move-stars 200s linear infinite;
        }

        .stars::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            box-shadow: 
                0 0 2px #fff,
                -10px -10px 1px #fff,
                20px 20px 2px #fff,
                -30px -30px 3px #fff,
                40px 40px 4px #fff,
                -50px -50px 5px #fff,
                60px 60px 6px #fff,
                -70px -70px 7px #fff,
                80px 80px 8px #fff,
                -90px -90px 9px #fff;
            animation: twinkle 5s linear infinite;
        }

        @keyframes move-stars {
            from {
                transform: translateY(0);
            }
            to {
                transform: translateY(-1000px);
            }
        }

        @keyframes twinkle {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* Кастомный стиль для сообщений */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            animation: fadeInOut 3s forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }

        /* Дополнительные стили для элементов */
        .backdrop-filter {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .backdrop-filter-2 {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
    </style>
    <!-- Иконки (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Шрифт -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
</head>
<body class="bg-gray-900 flex flex-col min-h-screen relative">
    <!-- Анимированный фон "Звездное небо" -->
    <div class="stars"></div>

    <!-- Header / Navigation -->
    <header class="bg-gray-900 bg-opacity-50 backdrop-filter-2 shadow-md p-4 w-full fixed top-0 left-0 z-50">
        <div class="flex justify-between items-center max-w-7xl mx-auto px-4 md:px-6">
            <h1 class="text-2xl md:text-3xl font-bold text-white">
                Asonik AI
            </h1>
            <div id="auth-info" class="flex items-center space-x-4">
                <!-- Информация о пользователе будет здесь -->
            </div>
        </div>
    </header>

    <!-- Основное содержимое -->
    <main class="flex-grow pt-20 pb-20 p-4 overflow-y-auto z-10">
        <div id="main-content" class="flex flex-col items-center justify-center min-h-full">
            <!-- Динамическое содержимое будет загружено сюда -->
        </div>
    </main>

    <!-- Секция чата (пока скрыта) -->
    <div id="chat-input-section" class="bg-gray-900 bg-opacity-75 backdrop-filter-2 shadow-lg p-4 w-full fixed bottom-0 left-0 z-50 transition-transform transform translate-y-full hidden md:flex md:translate-y-0 items-center justify-center">
        <div class="flex items-center w-full max-w-3xl">
            <input type="text" id="chat-input" placeholder="Отправьте сообщение..." class="flex-grow p-3 rounded-full border border-gray-600 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 mr-2">
            <button id="send-button" class="p-3 bg-purple-600 text-white rounded-full hover:bg-purple-700 transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
            </button>
            <button id="upload-button" class="p-3 bg-gray-600 text-white rounded-full hover:bg-gray-700 transition duration-300 ml-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
            </button>
        </div>
    </div>
</body>
</html>
